import{f as ss,g as ts,G as vs,r as k,i as _,P as ms,c as a,o as i,a as s,F as h,l as U,v as O,b as c,d as u,L as bs,x as A,j as G,t as p,p as P,n as j,O as Z,N as gs,E as xs,u as hs}from"#entry";const _s={class:"space-y-6"},ws={class:"card bg-base-100 shadow-sm"},ys={class:"card-body p-4"},ks={class:"flex flex-wrap gap-4 items-end justify-between"},Ss={class:"flex flex-wrap gap-4 items-end"},Cs={class:"form-control"},Is=["disabled"],Gs={class:"flex flex-wrap gap-4 items-end mt-4 border-t pt-4"},Ds={class:"flex items-center gap-2 flex-1 min-w-[200px]"},$s=["disabled"],Ts={key:1,class:"flex flex-wrap gap-x-4 gap-y-2 items-center justify-between"},Ns={class:"flex items-center gap-3 flex-wrap"},Es={class:"flex items-center gap-2 text-info font-semibold"},Ms={class:"flex items-center gap-2"},As=["disabled"],Ps={class:"flex gap-6 h-[calc(100vh-220px)]"},js={class:"card bg-base-100 shadow-sm h-full flex flex-col"},Vs={class:"card-body flex flex-col h-full"},Fs={class:"flex items-center justify-between mb-4"},Ls={key:0,class:"card-title text-base flex items-center whitespace-nowrap"},Us={class:"badge badge-neutral ml-2"},Os=["title"],Rs=["onDragstart"],zs={class:"font-medium"},Bs={class:"text-sm text-base-content/70"},Ws={class:"text-sm font-semibold text-primary"},Js={key:0,class:"text-center text-base-content/50 py-8"},qs={class:"flex-1 grid gap-6 grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 content-start overflow-y-auto overflow-x-auto"},Hs={class:"card-body"},Ks={class:"flex justify-between items-center mb-4"},Qs={class:"card-title text-base flex items-center"},Xs={class:"badge badge-neutral ml-2"},Ys={class:"dropdown dropdown-end"},Zs={tabindex:"0",role:"button",class:"btn btn-ghost btn-sm btn-circle"},st={tabindex:"0",class:"dropdown-content menu bg-base-100 rounded-box z-[1] w-48 p-2 shadow"},tt=["onClick"],et=["onClick"],nt=["onClick"],ot=["onClick"],lt={class:"stats shadow mb-3"},at={class:"stat py-2"},it={class:"stat-value text-lg text-primary"},rt=["onDrop"],dt=["onDragstart"],ct={class:"font-medium text-sm flex items-center"},ut={key:0,class:"ml-2 px-2 py-0.5 rounded bg-gray-300 text-xs text-gray-600"},pt={class:"text-xs text-base-content/70"},ft={class:"text-xs font-semibold text-primary flex items-center gap-1"},vt={class:"opacity-60"},mt={class:"text-success font-bold"},bt={key:0,class:"text-center text-base-content/50 py-4 text-sm"},gt={class:"flex gap-2 mt-3"},xt=["onClick","disabled","title"],ht=["onClick","disabled","title"],_t={class:"modal-box w-11/12 max-w-4xl"},wt={class:"text-lg font-bold mb-4 flex items-center"},yt={class:"space-y-4"},kt={class:"text-2xl font-bold w-8"},St={class:"flex-1"},Ct={class:"font-semibold"},It={class:"text-sm text-base-content/70"},Gt={class:"text-right"},Dt={class:"text-2xl font-bold text-primary"},$t={class:"modal-action"},Tt={key:0,class:"w-full"},Nt={class:"flex justify-between items-center flex-wrap gap-y-2 gap-x-4"},Et={class:"flex gap-2 flex-wrap"},Mt=["disabled"],At={key:1,class:"w-full flex justify-end"},Pt=ss({__name:"GroupingTab",props:{classInfo:{}},setup(R){function V(o,t){let n=null;return function(...e){n&&clearTimeout(n),n=setTimeout(()=>{o.apply(this,e)},t)}}const r=R,v=ts(),{exportToExcel:S}=gs(),{groupingBaseScores:D,groupingSessionScores:$,groupingActivityNames:es}=vs(v),T=k(),C=k(r.classInfo.groupCount||4),I=k(null),d=k([]),g=k(!1),N=k(!1),m=_({get:()=>es.value[r.classInfo.id]||"",set:o=>{v.setGroupingActivityName(r.classInfo.id,o)}}),F=_(()=>D.value[r.classInfo.id]||{}),z=_(()=>$.value[r.classInfo.id]||{}),L=_(()=>r.classInfo.students.filter(o=>o.isPresent&&!d.value.some(t=>t.members.some(n=>n.id===o.id)))),B=_(()=>[...d.value].sort((o,t)=>t.totalScore-o.totalScore)),f=o=>o.members.map(t=>r.classInfo.students.find(e=>e.id===t.id)||t),b=V(()=>{v.updateGroups(r.classInfo.id,d.value)},500),ns=(o,t=!0)=>{const n={id:`group_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:o.trim(),members:[],totalScore:0,averageScore:0,createdAt:new Date,color:os()};return d.value.push(n),t&&b(),n},os=()=>{const o=["#3b82f6","#ef4444","#10b981","#f59e0b","#8b5cf6","#ec4899","#06b6d4","#84cc16"];return o[d.value.length%o.length]},ls=()=>{if(confirm("這將重新分配所有學生，確定要繼續嗎？")){d.value=[];for(let n=1;n<=C.value;n++)ns(`第 ${n} 組`,!1);[...r.classInfo.students.filter(n=>n.isPresent)].sort(()=>Math.random()-.5).forEach((n,e)=>{const l=e%C.value;q(n.id,d.value[l].id,!1)}),b()}},as=()=>{confirm("這會將所有學生移回未分組狀態，但會保留現有組別。確定嗎？")&&(d.value.forEach(o=>{o.members=[]}),b())},W=o=>{I.value=o},J=o=>{I.value&&(o==="unassigned"?H(I.value):q(I.value,o),I.value=null)},q=(o,t,n=!0)=>{const e=r.classInfo.students.find(w=>w.id===o),l=d.value.find(w=>w.id===t);!e||!l||(H(o,!1),l.members.push({...e}),n&&b())},H=(o,t=!0)=>{d.value.forEach(n=>{const e=n.members.findIndex(l=>l.id===o);e>-1&&n.members.splice(e,1)}),t&&b()},E=(o,t)=>{r.classInfo.groupingActive&&v.addScoreToGroup(r.classInfo.id,o,t)},is=o=>{const t=d.value.find(e=>e.id===o);if(!t)return;const n=prompt("請輸入新的組名：",t.name);n&&n.trim()&&(t.name=n.trim(),b())},rs=o=>{if(confirm("確定要刪除此組別嗎？組內學生將移至未分組。")){const t=d.value.findIndex(n=>n.id===o);t>-1&&(d.value.splice(t,1),b())}},ds=()=>{v.startClassGrouping(r.classInfo.id)},cs=()=>{N.value=!0,T.value?.showModal()},K=()=>{v.endClassGrouping(r.classInfo.id),M()},us=()=>{confirm("確認要重設各組分數嗎？這將清除所有組別的總分。")&&(d.value.forEach(o=>{o.totalScore=0}),b(),K())},Q=()=>{N.value=!1,T.value?.showModal()},M=()=>{T.value?.close(),N.value=!1},X=()=>{const o=new Date,t=o.toISOString().split("T")[0],n=B.value.map((y,x)=>({排行:x+1,組別:y.name,總分:y.totalScore,人數:f(y).length})),e={sheetName:"分組摘要",header:[["活動名稱:",m.value||"未命名"],["班級:",r.classInfo.name],["匯出日期:",o.toLocaleString("zh-TW")],[]],data:n,columnWidths:[{wch:8},{wch:25},{wch:10},{wch:10}]},w={sheetName:"學生得分明細",data:d.value.flatMap(y=>f(y).map(x=>{const fs=F.value[x.id]??0,Y=z.value[x.id]??0;return{組別:y.name,座號:x.id,姓名:x.name,出席情況:x.isPresent?"出席":"缺席",本次活動得分:Y,活動後總分:fs+Y}})),columnWidths:[{wch:25},{wch:10},{wch:15},{wch:12},{wch:15},{wch:15}]},ps=`${t}-${m.value||"分組活動報告"}-${r.classInfo.name}`;S([e,w],ps)};return ms(()=>{d.value=JSON.parse(JSON.stringify(r.classInfo.groups||[])),C.value=r.classInfo.groupCount||4}),(o,t)=>{const n=bs;return i(),a("div",_s,[s("div",ws,[s("div",ys,[o.classInfo.groupingActive?(i(),a("div",Ts,[s("div",Ns,[s("span",Es,[c(n,{name:"CircleDot",class:"w-5 h-5 animate-pulse"}),t[15]||(t[15]=s("span",null,"分組進行中",-1))]),U(s("input",{"onUpdate:modelValue":t[2]||(t[2]=e=>m.value=e),type:"text",placeholder:"請輸入活動名稱...",class:"input input-sm input-bordered w-auto max-w-xs"},null,512),[[O,m.value]])]),s("div",Ms,[s("button",{onClick:X,class:"btn btn-sm btn-info gap-1",disabled:!m.value.trim(),title:"匯出活動報告"},[c(n,{name:"Download",class:"w-4 h-4"}),t[16]||(t[16]=u(" 匯出 ",-1))],8,As),s("button",{onClick:Q,class:"btn btn-sm btn-warning gap-1",title:"顯示積分儀表板"},[c(n,{name:"Trophy",class:"w-4 h-4"}),t[17]||(t[17]=u(" 儀表板 ",-1))]),s("button",{onClick:cs,class:"btn btn-sm btn-error gap-1"},[c(n,{name:"Square",class:"w-4 h-4"}),t[18]||(t[18]=u(" 結束分組 ",-1))])])])):(i(),a(h,{key:0},[s("div",ks,[s("div",Ss,[s("div",Cs,[t[9]||(t[9]=s("label",{class:"label py-1 mr-2"},[s("span",{class:"label-text"},"組數")],-1)),U(s("input",{"onUpdate:modelValue":t[0]||(t[0]=e=>C.value=e),type:"number",min:"2",max:"10",class:"input input-bordered w-20"},null,512),[[O,C.value,void 0,{number:!0}]])]),s("button",{onClick:ls,class:"btn btn-primary"},[c(n,{name:"Shuffle",class:"w-4 h-4 mr-2"}),t[10]||(t[10]=u(" 一鍵隨機分組 ",-1))]),s("button",{onClick:as,class:"btn btn-ghost"},[c(n,{name:"Undo2",class:"w-4 h-4 mr-2"}),t[11]||(t[11]=u(" 一鍵還原 ",-1))])]),s("button",{onClick:ds,class:"btn btn-success gap-2",disabled:d.value.length===0},[c(n,{name:"Play",class:"w-4 h-4"}),t[12]||(t[12]=u(" 開始分組 ",-1))],8,Is)]),s("div",Gs,[s("div",Ds,[t[13]||(t[13]=s("label",{class:"whitespace-nowrap text-base-content/80 mr-2"},"活動名稱 (選填)",-1)),U(s("input",{"onUpdate:modelValue":t[1]||(t[1]=e=>m.value=e),type:"text",placeholder:"例如：第二次分組討論",class:"input input-bordered flex-1 min-w-0"},null,512),[[O,m.value]])]),s("button",{onClick:Q,class:"btn btn-warning ml-2",disabled:d.value.length===0},[c(n,{name:"Trophy",class:"w-4 h-4 mr-2"}),t[14]||(t[14]=u(" 積分儀表板 ",-1))],8,$s)])],64))])]),s("div",Ps,[s("aside",{class:A(["transition-all duration-300 flex-shrink-0",g.value?"w-20":"w-80"])},[s("div",js,[s("div",Vs,[s("div",Fs,[g.value?G("",!0):(i(),a("h3",Ls,[c(n,{name:"Users",class:"w-5 h-5 mr-2"}),t[19]||(t[19]=u(" 未分組學生 ",-1)),s("span",Us,p(L.value.length)+" 人",1)])),s("button",{onClick:t[3]||(t[3]=e=>g.value=!g.value),class:"btn btn-ghost btn-sm btn-circle",title:g.value?"展開":"收合"},[c(n,{name:g.value?"ChevronsRight":"ChevronsLeft",class:"w-4 h-4"},null,8,["name"])],8,Os)]),g.value?G("",!0):(i(),a("div",{key:0,class:"flex-1 overflow-y-auto space-y-2 p-1",onDrop:t[4]||(t[4]=e=>J("unassigned")),onDragover:t[5]||(t[5]=P(()=>{},["prevent"])),onDragenter:t[6]||(t[6]=P(()=>{},["prevent"]))},[(i(!0),a(h,null,j(L.value,e=>(i(),a("div",{key:e.id,class:A(["p-3 bg-base-200 rounded-lg cursor-move hover:bg-base-300 transition-colors","flex justify-between items-center"]),draggable:"true",onDragstart:l=>W(e.id)},[s("div",null,[s("div",zs,p(e.name),1),s("div",Bs," 座號 "+p(e.id),1)]),s("div",Ws,p(e.totalScore)+"分 ",1)],40,Rs))),128)),L.value.length===0?(i(),a("div",Js," 所有學生都已分組 ")):G("",!0)],32))])])],2),s("main",qs,[(i(!0),a(h,null,j(d.value,e=>(i(),a("div",{key:e.id,class:"card bg-base-100 shadow-sm"},[s("div",Hs,[s("div",Ks,[s("h3",Qs,[s("div",{class:"w-4 h-4 rounded-full mr-2",style:Z({backgroundColor:e.color})},null,4),u(" "+p(e.name)+" ",1),s("span",Xs,p(f(e).length)+" 人",1)]),s("div",Ys,[s("div",Zs,[c(n,{name:"MoreVertical",class:"w-4 h-4"})]),s("ul",st,[s("li",null,[s("a",{onClick:l=>is(e.id)},[c(n,{name:"Edit",class:"w-4 h-4"}),t[20]||(t[20]=u(" 編輯組名 ",-1))],8,tt)]),s("li",null,[s("a",{onClick:l=>E(e.id,1),class:"text-success"},[c(n,{name:"Plus",class:"w-4 h-4"}),t[21]||(t[21]=u(" 加 1 分 ",-1))],8,et)]),s("li",null,[s("a",{onClick:l=>E(e.id,-1),class:"text-error"},[c(n,{name:"Minus",class:"w-4 h-4"}),t[22]||(t[22]=u(" 扣 1 分 ",-1))],8,nt)]),s("li",null,[s("a",{onClick:l=>rs(e.id),class:"text-error"},[c(n,{name:"Trash2",class:"w-4 h-4"}),t[23]||(t[23]=u(" 刪除組別 ",-1))],8,ot)])])])]),s("div",lt,[s("div",at,[t[24]||(t[24]=s("div",{class:"stat-title text-xs"},"總分",-1)),s("div",it,p(e.totalScore),1)])]),s("div",{class:"min-h-32 p-3 border-2 border-dashed border-base-300 rounded-lg space-y-2",onDrop:l=>J(e.id),onDragover:t[7]||(t[7]=P(()=>{},["prevent"])),onDragenter:t[8]||(t[8]=P(()=>{},["prevent"]))},[(i(!0),a(h,null,j(f(e),l=>(i(),a("div",{key:l.id,class:A(["p-2 rounded cursor-move flex justify-between items-center transition-colors",l.isPresent?"bg-base-200 hover:bg-base-300":"bg-gray-200 text-gray-400 opacity-60"]),draggable:"true",onDragstart:w=>W(l.id)},[s("div",null,[s("div",ct,[u(p(l.name)+" ",1),l.isPresent?G("",!0):(i(),a("span",ut,"今日缺席"))]),s("div",pt,p(l.id),1)]),s("div",ft,[r.classInfo.groupingActive?(i(),a(h,{key:0},[s("span",vt,p(F.value[l.id]??""),1),c(n,{name:"ArrowRight",class:"w-3 h-3 text-success"}),s("span",mt,p((F.value[l.id]??0)+(z.value[l.id]??0)),1),t[25]||(t[25]=s("span",{class:"text-success"},"分",-1))],64)):(i(),a(h,{key:1},[u(p(l.totalScore)+"分 ",1)],64))])],42,dt))),128)),f(e).length===0?(i(),a("div",bt," 拖拽學生到此組 ")):G("",!0)],40,rt),s("div",gt,[s("button",{onClick:l=>E(e.id,1),class:"btn btn-success btn-sm flex-1",disabled:!o.classInfo.groupingActive||f(e).every(l=>!l.isPresent),title:f(e).every(l=>!l.isPresent)?"本組全員缺席，無法加分":""}," +1 ",8,xt),s("button",{onClick:l=>E(e.id,-1),class:"btn btn-error btn-sm flex-1",disabled:!o.classInfo.groupingActive||f(e).every(l=>!l.isPresent),title:f(e).every(l=>!l.isPresent)?"本組全員缺席，無法扣分":""}," -1 ",8,ht)])])]))),128))])]),s("dialog",{ref_key:"scoreboardModal",ref:T,class:"modal"},[s("div",_t,[s("h3",wt,[c(n,{name:"Trophy",class:"w-5 h-5 mr-2"}),t[26]||(t[26]=u(" 小組積分儀表板 ",-1))]),s("div",yt,[(i(!0),a(h,null,j(B.value,(e,l)=>(i(),a("div",{key:e.id,class:A(["flex items-center gap-4 p-4 rounded-lg",l===0?"bg-warning/20":l===1?"bg-info/20":l===2?"bg-accent/20":"bg-base-200"])},[s("div",kt,p(l+1),1),s("div",{class:"w-6 h-6 rounded-full",style:Z({backgroundColor:e.color})},null,4),s("div",St,[s("div",Ct,p(e.name),1),s("div",It,p(f(e).length)+" 人 ",1)]),s("div",Gt,[s("div",Dt,p(e.totalScore),1)])],2))),128))]),s("div",$t,[N.value?(i(),a("div",Tt,[s("div",Nt,[s("div",Et,[s("button",{onClick:X,class:"btn btn-info",disabled:!m.value.trim()},[c(n,{name:"Download",class:"w-4 h-4 mr-2"}),t[27]||(t[27]=u(" 匯出活動報表 ",-1))],8,Mt),s("button",{onClick:us,class:"btn btn-warning"}," 結束並重設分數 "),s("button",{onClick:K,class:"btn btn-success"}," 結束並保留分數 ")]),s("button",{onClick:M,class:"btn btn-ghost"}," 取消 ")]),t[28]||(t[28]=s("p",{class:"text-xs text-base-content/60 mt-3 w-full"}," 提醒：活動結束後就不可再匯出此次分組活動的報告。 ",-1))])):(i(),a("div",At,[s("button",{onClick:M,class:"btn"},"關閉")]))])]),s("form",{method:"dialog",class:"modal-backdrop"},[s("button",{onClick:M},"close")])],512)])}}}),jt=Object.assign(Pt,{__name:"GroupingTab"}),Vt={key:0,class:"p-4 sm:p-6"},Ft={key:1,class:"text-center p-8"},Ut=ss({__name:"grouping",setup(R){const V=ts(),r=xs(),v=_(()=>r.params.id),S=_(()=>V.classes.find(D=>D.id===v.value));return hs(()=>({title:`${S.value?.name||"班級分組"} - 分組模式`})),(D,$)=>S.value?(i(),a("div",Vt,[c(jt,{"class-info":S.value},null,8,["class-info"])])):(i(),a("div",Ft,[...$[0]||($[0]=[s("p",null,"正在載入班級資料...",-1),s("span",{class:"loading loading-lg loading-spinner text-primary"},null,-1)])]))}});export{Ut as default};
