import{f as at,u as rt,y as it,g as dt,r as c,i as m,z as q,A as ut,c as n,o as l,b as f,a as t,j as h,l as A,v as z,B as K,d as x,L as ct,F as g,n as k,t as a,k as G,x as J,p as Q,C as mt}from"#entry";import{P as vt}from"./CkQK_kZe.js";const pt={class:"p-4 sm:p-6"},bt={class:"flex flex-col sm:flex-row justify-between items-center mb-4 gap-2"},ht={class:"w-full sm:w-1/2"},xt={class:"flex items-center gap-2"},gt={class:"form-control"},kt={class:"label cursor-pointer"},_t={class:"overflow-x-auto glass-card p-4 rounded-xl"},ft={class:"table"},wt={class:"inline-flex items-center gap-1"},yt={key:0,class:"w-3 h-3"},Ct={key:0,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",stroke:"currentColor",class:"w-3 h-3"},St={key:1,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",stroke:"currentColor",class:"w-3 h-3"},Mt={class:"inline-flex items-center gap-1"},At={key:0,class:"w-3 h-3"},Ht={key:0,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",stroke:"currentColor",class:"w-3 h-3"},Ft={key:1,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",stroke:"currentColor",class:"w-3 h-3"},Lt={class:"align-top"},Dt={class:"font-semibold text-base-content"},Bt={key:0,class:"text-xs text-base-content/60 mt-1"},$t={class:"align-top whitespace-nowrap"},jt={class:"align-top max-w-xs"},It={class:"text-sm text-base-content/70 whitespace-pre-line"},Pt={class:"align-top"},Vt={key:0,class:"badge badge-ghost"},zt={key:1,class:"badge badge-success"},Nt={class:"align-top"},Tt={key:0,class:"flex items-center gap-2"},Et=["onClick"],Ut={class:"text-xs text-base-content/60"},Ot={key:1,class:"text-xs text-base-content/60"},Rt={class:"text-right"},qt={class:"flex justify-end space-x-2"},Kt={class:"tooltip","data-tip":"編輯"},Gt=["onClick"],Jt=["data-tip"],Qt=["onClick"],Wt={class:"tooltip","data-tip":"刪除"},Xt=["onClick"],Yt={key:0},Zt={colspan:"6",class:"text-center py-8"},te={class:"text-base-content/60"},ee={key:0,class:"mt-4 flex flex-col sm:flex-row items-center justify-between gap-3"},se={class:"text-sm text-base-content/70"},oe={class:"join"},ne=["disabled"],le=["onClick"],ae=["disabled"],re={class:"modal-box max-w-3xl bg-base-100"},ie={class:"flex items-start justify-between mb-4"},de={class:"text-lg font-bold"},ue={key:0,class:"text-base-content/70 text-sm font-normal"},ce={key:0,class:"overflow-x-auto"},me={class:"table table-sm table-zebra"},ve={class:"align-top"},pe={class:"font-semibold text-base-content group-hover:text-primary"},be={key:0,class:"text-xs text-base-content/50 mt-1 group-hover:text-base-content/70"},he={class:"text-center font-medium group-hover:text-primary"},xe={key:0,class:"group-hover:text-primary"},ge={key:1,class:"text-base-content/30"},ke={class:"bg-base-200"},_e={class:"text-center"},fe={key:1,class:"py-10 text-center text-base-content/60"},we={class:"font-bold text-xl mb-2 text-primary"},ye={class:"grid grid-cols-1 sm:grid-cols-2 gap-1 p-2 border rounded-lg bg-base-200 max-h-40 overflow-y-auto"},Ce=["value"],Se={class:"label-text"},Me={class:"modal-action mt-6"},Ae={type:"submit",class:"btn btn-primary"},H=10,De=at({__name:"homework",setup(He){rt({title:"作業管理"});const v=it(),F=dt(),$=c(!1),w=c(!1),i=c({hiddenFromClassIds:[]}),y=c(!1),C=c(""),S=c("createdAt"),p=c("desc");function N(o){S.value===o?p.value=p.value==="asc"?"desc":"asc":(S.value=o,p.value="asc")}const b=m(()=>{let o=v.homeworkList.filter(e=>e.isArchived===y.value);if(C.value.trim()){const e=C.value.trim().toLowerCase();o=o.filter(r=>r.name.toLowerCase().includes(e)||(r.notes?.toLowerCase().includes(e)??!1))}return o=[...o].sort((e,r)=>{if(S.value==="name"){const s=e.name.localeCompare(r.name);return p.value==="asc"?s:-s}else{const s=new Date(e.createdAt).getTime()-new Date(r.createdAt).getTime();return p.value==="asc"?s:-s}}),o}),d=c(1),L=m(()=>{const o=Math.ceil(b.value.length/H);return o>0?o:1}),W=m(()=>Array.from({length:L.value},(o,e)=>e+1)),X=m(()=>{const o=(d.value-1)*H;return b.value.slice(o,o+H)}),Y=m(()=>b.value.length===0?0:(d.value-1)*H+1),Z=m(()=>{const o=d.value*H;return Math.min(o,b.value.length)});q([C,y],()=>{d.value=1}),q(L,o=>{d.value>o&&(d.value=o)});const M=["pending","submitted","needs_correction","completed"],tt={pending:{text:"未繳交",short:"未交"},submitted:{text:"已繳交",short:"已交"},needs_correction:{text:"待訂正",short:"待訂"},completed:{text:"已完成",short:"完成"}},D=m(()=>{const o={};if(!Array.isArray(v.homeworkList)||!Array.isArray(F.classes))return o;for(const e of v.homeworkList){const r=F.classes.filter(s=>Array.isArray(e.hiddenFromClassIds)?!e.hiddenFromClassIds.includes(s.id):!0);o[e.id]=r.map(s=>{const u={pending:0,submitted:0,needs_correction:0,completed:0},P=s.homeworkSettings?.find(V=>V.homeworkId===e.id);return!P||!P.studentStatus?{classId:s.id,className:s.name,totalStudents:s.students.length,counts:u,hasData:!1}:(s.students.forEach(V=>{const R=P.studentStatus?.[V.id]??"pending",lt=M.includes(R)?R:"pending";u[lt]+=1}),{classId:s.id,className:s.name,totalStudents:s.students.length,counts:u,hasData:!0})})}return o}),j=c(null),_=c(null),T=m(()=>_.value&&v.homeworkList.find(o=>o.id===_.value)||null),I=m(()=>_.value?D.value[_.value]||[]:[]),E=m(()=>{const o={pending:0,submitted:0,needs_correction:0,completed:0};let e=0;return I.value.forEach(r=>{e+=r.totalStudents,r.hasData&&M.forEach(s=>{o[s]+=r.counts[s]})}),{totalStudents:e,counts:o}}),et=async o=>{(D.value[o]||[]).length!==0&&(_.value=o,await mt(),j.value?.showModal())},U=()=>{j.value?.close()},st=()=>{_.value=null},O=(o=null)=>{o?(w.value=!0,i.value={...o,hiddenFromClassIds:[...o.hiddenFromClassIds||[]]}):(w.value=!1,i.value={name:"",notes:"",hiddenFromClassIds:[]}),$.value=!0},B=()=>{$.value=!1},ot=()=>{i.value.name&&(w.value?v.updateHomework(i.value.id,i.value):v.addHomework({name:i.value.name,notes:i.value.notes,hiddenFromClassIds:i.value.hiddenFromClassIds||[]}),B())},nt=o=>{confirm("確定要刪除這個作業範本嗎？此操作無法復原。")&&v.deleteHomework(o)};return ut(()=>{v.fetchAllHomework(),F.loadFromStorage()}),(o,e)=>{const r=ct;return l(),n("div",pt,[f(vt,{title:"作業管理",description:"這裡是管理所有班級作業範本的地方。您可以在此建立、編輯、封存作業。"}),t("div",bt,[t("div",ht,[A(t("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=s=>C.value=s),class:"input input-bordered w-full",placeholder:"搜尋作業名稱或備註..."},null,512),[[z,C.value]])]),t("div",xt,[t("div",gt,[t("label",kt,[e[11]||(e[11]=t("span",{class:"label-text mr-2"},"顯示已封存作業",-1)),A(t("input",{type:"checkbox","onUpdate:modelValue":e[1]||(e[1]=s=>y.value=s),class:"toggle toggle-primary"},null,512),[[K,y.value]])])]),t("button",{class:"btn btn-primary",onClick:e[2]||(e[2]=s=>O())},[f(r,{name:"Plus",class:"w-4 h-4"}),e[12]||(e[12]=x(" 新增作業 ",-1))])])]),t("div",_t,[t("table",ft,[t("thead",null,[t("tr",null,[t("th",{class:"cursor-pointer select-none transition text-base-content/80 hover:text-primary relative group",onClick:e[3]||(e[3]=s=>N("name"))},[t("span",wt,[e[15]||(e[15]=x(" 作業名稱 ",-1)),S.value==="name"?(l(),n("span",yt,[p.value==="asc"?(l(),n("svg",Ct,[...e[13]||(e[13]=[t("path",{"stroke-linecap":"round","stroke-width":"2",d:"M8 4l4 6H4l4-6z"},null,-1)])])):(l(),n("svg",St,[...e[14]||(e[14]=[t("path",{"stroke-linecap":"round","stroke-width":"2",d:"M8 12l-4-6h8l-4 6z"},null,-1)])]))])):h("",!0)])]),t("th",{class:"cursor-pointer select-none transition text-base-content/80 hover:text-primary relative group",onClick:e[4]||(e[4]=s=>N("createdAt"))},[t("span",Mt,[e[18]||(e[18]=x(" 建立日期 ",-1)),S.value==="createdAt"?(l(),n("span",At,[p.value==="asc"?(l(),n("svg",Ht,[...e[16]||(e[16]=[t("path",{"stroke-linecap":"round","stroke-width":"2",d:"M8 4l4 6H4l4-6z"},null,-1)])])):(l(),n("svg",Ft,[...e[17]||(e[17]=[t("path",{"stroke-linecap":"round","stroke-width":"2",d:"M8 12l-4-6h8l-4 6z"},null,-1)])]))])):h("",!0)])]),e[19]||(e[19]=t("th",null,"備註",-1)),e[20]||(e[20]=t("th",null,"狀態",-1)),e[21]||(e[21]=t("th",null,"班級概況",-1)),e[22]||(e[22]=t("th",{class:"text-right"},"操作",-1))])]),t("tbody",null,[(l(!0),n(g,null,k(X.value,s=>(l(),n("tr",{key:s.id,class:"align-top"},[t("td",Lt,[t("div",Dt,a(s.name),1),(s.hiddenFromClassIds?.length??0)>0?(l(),n("div",Bt," 已對 "+a(s.hiddenFromClassIds?.length)+" 個班級隱藏 ",1)):h("",!0)]),t("td",$t,a(new Date(s.createdAt).toLocaleDateString()),1),t("td",jt,[t("p",It,a(s.notes||"—"),1)]),t("td",Pt,[s.isArchived?(l(),n("span",Vt,"已封存")):(l(),n("span",zt,"啟用中"))]),t("td",Nt,[(D.value[s.id]||[]).length>0?(l(),n("div",Tt,[t("button",{class:"btn btn-xs btn-outline gap-1",onClick:u=>et(s.id)},[f(r,{name:"BarChart3",class:"w-3 h-3"}),e[23]||(e[23]=t("span",null,"概況",-1))],8,Et),t("span",Ut,a(D.value[s.id].length)+" 班 ",1)])):(l(),n("span",Ot,"尚未指派"))]),t("td",Rt,[t("div",qt,[t("div",Kt,[t("button",{class:"btn btn-ghost btn-sm",onClick:u=>O(s)},[f(r,{name:"Edit",class:"w-4 h-4"})],8,Gt)]),t("div",{class:"tooltip","data-tip":s.isArchived?"恢復":"封存"},[t("button",{class:"btn btn-ghost btn-sm",onClick:u=>G(v).toggleArchive(s.id)},[f(r,{name:s.isArchived?"ArchiveRestore":"Archive",class:"w-4 h-4"},null,8,["name"])],8,Qt)],8,Jt),t("div",Wt,[t("button",{class:"btn btn-ghost btn-sm text-error",onClick:u=>nt(s.id)},[f(r,{name:"Trash2",class:"w-4 h-4"})],8,Xt)])])])]))),128)),b.value.length===0?(l(),n("tr",Yt,[t("td",Zt,[t("p",te,a(y.value?"沒有已封存的作業":"尚未建立任何作業範本"),1)])])):h("",!0)])])]),b.value.length>0?(l(),n("div",ee,[t("span",se," 顯示第 "+a(Y.value)+" - "+a(Z.value)+" 筆，共 "+a(b.value.length)+" 筆 ",1),t("div",oe,[t("button",{class:"btn btn-sm join-item",disabled:d.value===1,onClick:e[5]||(e[5]=s=>d.value=Math.max(1,d.value-1))}," « ",8,ne),(l(!0),n(g,null,k(W.value,s=>(l(),n("button",{key:s,class:J(["btn btn-sm join-item",{"btn-active":d.value===s}]),onClick:u=>d.value=s},a(s),11,le))),128)),t("button",{class:"btn btn-sm join-item",disabled:d.value===L.value,onClick:e[6]||(e[6]=s=>d.value=Math.min(L.value,d.value+1))}," » ",8,ae)])])):h("",!0),t("dialog",{ref_key:"summaryModalRef",ref:j,class:"modal",onClose:st},[t("div",re,[t("div",ie,[t("div",null,[t("h3",de,[e[24]||(e[24]=x(" 班級概況 ",-1)),T.value?(l(),n("span",ue," - "+a(T.value.name),1)):h("",!0)]),e[25]||(e[25]=t("p",{class:"text-xs text-base-content/60 mt-1"}," 顯示目前已指派班級的繳交狀態統計，協助快速掌握進度。 ",-1))]),t("button",{class:"btn btn-sm btn-ghost",onClick:U},"關閉")]),I.value.length>0?(l(),n("div",ce,[t("table",me,[t("thead",null,[t("tr",null,[e[26]||(e[26]=t("th",null,"班級",-1)),e[27]||(e[27]=t("th",{class:"text-center"},"學生數",-1)),(l(),n(g,null,k(M,s=>t("th",{key:s,class:"text-center"},a(tt[s].text),1)),64))])]),t("tbody",null,[(l(!0),n(g,null,k(I.value,s=>(l(),n("tr",{key:s.classId,class:"transition-colors hover:bg-primary/10 group"},[t("td",ve,[t("div",pe,a(s.className),1),s.hasData?h("",!0):(l(),n("div",be," 尚未設定繳交紀錄 "))]),t("td",he,a(s.totalStudents),1),(l(),n(g,null,k(M,u=>t("td",{key:u,class:"text-center font-medium transition-colors"},[s.hasData?(l(),n("span",xe,a(s.counts[u]),1)):(l(),n("span",ge,"—"))])),64))]))),128))]),t("tfoot",null,[t("tr",ke,[e[28]||(e[28]=t("th",null,"總計",-1)),t("th",_e,a(E.value.totalStudents),1),(l(),n(g,null,k(M,s=>t("th",{key:s,class:"text-center"},a(E.value.counts[s]),1)),64))])])])])):(l(),n("div",fe," 目前沒有可顯示的班級紀錄。 ")),t("div",{class:"modal-action"},[t("button",{class:"btn btn-primary",onClick:U},"了解")])])],544),t("div",{class:J(["modal",{"modal-open":$.value}]),onClick:B},[t("div",{class:"modal-box max-w-lg bg-base-100 shadow-xl",onClick:e[10]||(e[10]=Q(()=>{},["stop"]))},[t("h3",we,a(w.value?"編輯作業":"新增作業"),1),t("form",{onSubmit:Q(ot,["prevent"]),class:"space-y-5"},[t("div",null,[e[29]||(e[29]=t("label",{class:"label mb-1"},[t("span",{class:"label-text text-base font-semibold"},[x("作業名稱 "),t("span",{class:"text-error"},"*")])],-1)),A(t("input",{type:"text","onUpdate:modelValue":e[7]||(e[7]=s=>i.value.name=s),placeholder:"請輸入作業名稱",class:"input input-bordered w-full focus:outline-primary",required:""},null,512),[[z,i.value.name]])]),t("div",null,[e[30]||(e[30]=t("label",{class:"label mb-1"},[t("span",{class:"label-text text-base font-semibold"},[x("備註 "),t("span",{class:"text-xs text-base-content/60"},"(選填)")])],-1)),A(t("textarea",{"onUpdate:modelValue":e[8]||(e[8]=s=>i.value.notes=s),class:"textarea textarea-bordered w-full min-h-[80px] focus:outline-primary",placeholder:"請輸入備註內容"},null,512),[[z,i.value.notes]])]),t("div",null,[e[31]||(e[31]=t("label",{class:"label mb-1"},[t("span",{class:"label-text text-base font-semibold"},[x("對以下班級隱藏 "),t("span",{class:"text-xs text-base-content/60"},"(可多選)")])],-1)),t("div",ye,[(l(!0),n(g,null,k(G(F).classes,s=>(l(),n("label",{key:s.id,class:"flex items-center gap-3 px-2 py-1.5 rounded-md hover:bg-base-300 transition-colors cursor-pointer"},[A(t("input",{type:"checkbox",value:s.id,"onUpdate:modelValue":e[9]||(e[9]=u=>i.value.hiddenFromClassIds=u),class:"checkbox checkbox-sm checkbox-primary"},null,8,Ce),[[K,i.value.hiddenFromClassIds]]),t("span",Se,a(s.name),1)]))),128))])]),t("div",Me,[t("button",{type:"button",class:"btn btn-ghost",onClick:B}," 取消 "),t("button",Ae,a(w.value?"儲存變更":"確認新增"),1)])],32),t("button",{class:"btn btn-sm btn-circle btn-ghost absolute right-2 top-2",onClick:B}," ✕ ")])],2)])}}});export{De as default};
