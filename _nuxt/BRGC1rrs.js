import{f as Me,g as Te,D as rt,G as $e,r as w,i as S,z as W,c as a,o as i,a as s,b as d,d as f,L as ct,l as te,v as se,P as dt,x as I,F as N,j as g,t as v,p as E,n as q,T as ut,w as vt,O as ne,k as L,N as ft,_ as pt,E as mt,u as bt}from"#entry";const gt={class:"space-y-6"},ht={class:"card bg-base-100 shadow-sm"},xt={class:"card-body p-4"},_t={key:0,class:"flex flex-col gap-3"},wt={key:0,class:"flex flex-wrap items-center gap-2"},yt={class:"badge badge-info gap-2"},kt={class:"form-control mr-2"},St={class:"ml-auto flex gap-2"},Ct=["disabled"],Gt={key:1,class:"flex flex-wrap items-center gap-3"},It={class:"flex items-center gap-2 text-sm text-base-content/70"},Dt={class:"badge badge-outline gap-1",title:"如需調整請點擊「編輯組別」"},At={class:"ml-auto flex items-center gap-2"},$t=["disabled"],Mt=["disabled"],Tt=["disabled"],jt={key:1,class:"flex flex-wrap gap-x-4 gap-y-2 items-center justify-between"},Nt={class:"flex items-center gap-3 flex-wrap"},Vt={class:"flex items-center gap-2 text-info font-semibold"},Et={class:"flex items-center gap-2"},Pt=["disabled"],Ut=["disabled"],Lt=["disabled"],zt={class:"flex gap-6 h-[calc(100vh-220px)]"},Ft={class:"card bg-base-100 shadow-sm h-full flex flex-col"},Ot={class:"card-body flex flex-col h-full p-4"},Rt={class:"flex items-center justify-between mb-4"},Bt={key:0,class:"card-title text-base flex items-center whitespace-nowrap"},Wt={class:"badge badge-neutral ml-2"},qt=["title"],Kt={class:"sticky top-0 bg-base-100 pb-2 z-10"},Yt={class:"input input-bordered input-sm flex items-center gap-2"},Ht={class:"mt-3 flex items-center justify-between text-xs text-base-content/70"},Jt=["disabled"],Qt=["draggable","onDragstart"],Xt={class:"flex items-start gap-3 flex-1"},Zt=["checked","onClick"],es={class:"font-medium"},ts={class:"text-sm text-base-content/70"},ss={class:"text-sm font-semibold text-primary"},ns={key:0,class:"text-center text-base-content/50 py-8"},os={key:1,class:"flex justify-center items-center h-full"},ls={class:"flex items-center justify-between mb-4"},as={key:0,class:"card-title text-base flex items-center whitespace-nowrap"},is=["title"],rs={key:0,class:"flex-1 overflow-y-auto"},cs={class:"font-semibold text-sm truncate flex-1"},ds={key:0,class:"text-lg font-bold text-primary"},us={key:1,class:"flex justify-center items-center h-full"},vs={class:"card-body p-3"},fs={key:0,class:"flex justify-between items-center gap-3"},ps={class:"flex items-center gap-2 text-base font-semibold truncate"},ms={class:"truncate"},bs={class:"badge badge-ghost badge-sm"},gs={class:"dropdown dropdown-end"},hs={tabindex:"0",role:"button",class:"btn btn-ghost btn-xs btn-circle"},xs={tabindex:"0",class:"dropdown-content menu bg-base-100 rounded-box z-[1] w-48 p-2 shadow"},_s=["onClick"],ws=["onClick"],ys={key:1,class:"flex flex-col gap-2"},ks={class:"flex justify-between items-start"},Ss={class:"flex items-center gap-2 text-base font-semibold"},Cs={class:"flex items-center gap-2"},Gs=["onClick","disabled"],Is=["onClick","disabled"],Ds=["onDrop","onDragover","onDragenter"],As={key:0,class:"flex justify-end"},$s=["disabled","onClick"],Ms=["draggable","onDragstart","onDragover","onDrop"],Ts={key:0,class:"px-3 py-2 flex flex-col gap-1"},js={class:"text-xs text-base-content/70"},Ns={class:"font-medium text-sm"},Vs={key:1,class:"p-2 flex flex-col gap-2"},Es={class:"flex justify-between items-center"},Ps={class:"font-medium text-sm flex items-center"},Us={key:0,class:"ml-2 px-2 py-0.5 rounded bg-gray-300 text-xs text-gray-600"},Ls={class:"text-xs text-base-content/70"},zs={class:"flex justify-end items-center gap-2"},Fs={key:0,class:"flex items-center gap-1 text-xs"},Os={class:"opacity-60"},Rs={key:1,class:"flex gap-1"},Bs=["onClick"],Ws=["onClick"],qs={key:1,class:"flex flex-1 items-center justify-center text-center text-base-content/50 text-sm"},Ks={key:3,class:"text-xs text-base-content/60 italic text-center mt-2"},Ys={class:"modal-box w-11/12 max-w-4xl py-6 sm:py-8 max-h-[90vh] overflow-y-auto my-4 sm:my-6"},Hs={class:"text-lg font-bold mb-4 flex items-center"},Js={class:"space-y-4"},Qs={class:"text-2xl font-bold w-8"},Xs={class:"flex-1"},Zs={class:"font-semibold"},en={class:"text-sm text-base-content/70"},tn={key:0,class:"text-right"},sn={class:"text-2xl font-bold text-primary"},nn={class:"modal-action"},on={key:0,class:"w-full"},ln={class:"flex justify-between items-center flex-wrap gap-y-2 gap-x-4"},an={class:"flex gap-2 flex-wrap"},rn=["disabled"],cn={key:1,class:"w-full flex justify-end"},dn=Me({__name:"GroupingTab",props:{classInfo:{}},setup(ue){const c=ue,D=Te(),T=rt(),{exportToExcel:z}=ft(),{groupingSettings:j,groupingViewCollapsed:K}=$e(T),{groupingBaseScores:je,groupingSessionScores:Ne,groupingActivityNames:Ve,groupingSessionGroupScores:Ee,groupingSessionIndividualScores:Pe}=$e(D),Y=w(),oe=t=>{const e=Math.floor(Number(t));return!Number.isFinite(e)||e<2?2:Math.min(e,10)},A=w(oe(c.classInfo.groupCount)),$=w(String(A.value)),le=w(!1),r=w([]),y=w(!1),H=w(!1),P=w({}),J=w({}),ve=w(null),F=w(""),h=w([]),k=w({groupId:null,index:null}),M=w({studentIds:[],sourceGroupId:null}),x=w(!1),O=w(!0),V=S({get:()=>Ve.value[c.classInfo.id]||"",set:t=>{D.setGroupingActivityName(c.classInfo.id,t)}}),ae=S(()=>je.value[c.classInfo.id]||{}),fe=S(()=>Ne.value[c.classInfo.id]||{}),Q=S(()=>c.classInfo.students.filter(t=>t.isPresent&&!r.value.some(e=>e.members.some(o=>o.id===t.id)))),pe=S(()=>{const t=F.value.trim().toLowerCase();return t?Q.value.filter(e=>e.name.toLowerCase().includes(t)||String(e.id).toLowerCase().includes(t)):Q.value}),Ue=S(()=>Q.value.length),b=S(()=>x.value&&!c.classInfo.groupingActive),me=S(()=>[...r.value].sort((t,e)=>e.totalScore-t.totalScore)),be=S(()=>{const t=me.value,e=j.value.leaderboardDisplayCount;return e==="all"?t:t.slice(0,e)}),ge=S(()=>r.value.some(t=>t.members.length>0)),he=()=>{T.setGroupingViewCollapsed(!1)},xe=()=>{r.value.length!==0&&T.setGroupingViewCollapsed(!0)},C=t=>t.members.map(e=>c.classInfo.students.find(n=>n.id===e.id)||e),ie=t=>{const e=r.value.find(o=>o.id===t);return e?C(e):[]},G=()=>{const t=r.value.map(e=>({...e,members:e.members.map(o=>({...o}))}));le.value=!0,D.updateGroups(c.classInfo.id,t)},_e=t=>{const e=Array.isArray(t)?t:[];r.value=e.map(n=>({...n,members:n.members?.map(l=>({...l}))||[],createdAt:n.createdAt?new Date(n.createdAt):new Date})),r.value.length===0&&T.setGroupingViewCollapsed(!1);const o=new Set(r.value.map(n=>n.id));Object.keys(P.value).forEach(n=>{o.has(n)||delete P.value[n]}),x.value||(O.value=!0)},Le=(t,e=!0,o)=>{const n={id:`group_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:t.trim(),members:[],totalScore:0,averageScore:0,createdAt:new Date,color:X()};return r.value.push(n),e&&G(),n},re=["#3b82f6","#ef4444","#10b981","#f59e0b","#8b5cf6","#ec4899","#06b6d4","#84cc16"],X=t=>{const e=typeof t=="number"?t%re.length:r.value.length%re.length;return re[e]},we=()=>oe(A.value),ze=()=>{const t=Number($.value);if(!Number.isFinite(t)||t<2||t>10){alert("組數必須介於 2 到 10 之間。");return}if(!c.classInfo?.students?.length||(Z(),!confirm("這將重新分配所有學生，並將所有組別的總分歸零。確定要繼續嗎？")))return;const o=r.value.map((u,p)=>({id:u.id||`group_${Date.now()}_${p}`,name:u.name?.trim()||`第 ${p+1} 組`,color:u.color||X(p),totalScore:0,averageScore:0,createdAt:u.createdAt?new Date(u.createdAt):new Date})),l=(o.length?o:Array.from({length:we()},(u,p)=>({id:`group_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:`第 ${p+1} 組`,color:X(p),totalScore:0,averageScore:0,createdAt:new Date}))).map((u,p)=>({...u,members:[],color:u.color||X(p)}));r.value=l,P.value={};const m=c.classInfo.students.filter(u=>u.isPresent);if(r.value.length===0){alert("未建立任何組別，請先設定有效的組數");return}if(m.length===0){alert("目前沒有出席學生可供分組");return}[...m].sort(()=>Math.random()-.5).forEach((u,p)=>{const B=p%r.value.length;r.value[B].members.push({...u})}),x.value||G()},ye=(t,e=!0)=>{const o=r.value.length;let n=!1;if(t>o)for(let l=o;l<t;l++)Le(`第 ${l+1} 組`,!1),n=!0;else t<o&&(n=r.value.splice(t).length>0);return n&&e&&G(),n},Z=()=>{if(String($.value).trim()===""){$.value=String(A.value);return}const t=Number($.value);if(!Number.isFinite(t)){$.value=String(A.value);return}const e=Math.min(Math.max(Math.floor(t),2),10);e!==A.value&&(A.value=e,ye(e,!1)&&!x.value&&G(),D.updateGroupCount(c.classInfo.id,e)),$.value=String(A.value)},Fe=()=>{Z();const t=we();ye(t,!x.value)},Oe=()=>{confirm("這會將所有學生移回未分組狀態，但會保留現有組別。確定嗎？")&&(r.value=r.value.map(t=>({...t,members:[]})),x.value||G(),U())},Re=t=>{b.value&&(h.value.includes(t)?h.value=h.value.filter(e=>e!==t):h.value=[...h.value,t])},U=()=>{h.value=[]},ce=t=>{const e=ve.value;if(!e)return;const o=e.getBoundingClientRect(),n=80,l=20;t.clientY<o.top+n?e.scrollTop-=l:t.clientY>o.bottom-n&&(e.scrollTop+=l)},ke=(t,e,o)=>{if(!b.value){o.preventDefault();return}const n=new Set(h.value),l=e==="unassigned"&&n.size>0&&n.has(t)?Array.from(n):[t];M.value={studentIds:l,sourceGroupId:e},k.value={groupId:null,index:null},o.dataTransfer?.setData("text/plain",l.join(","))},Se=()=>{k.value={groupId:null,index:null}},Be=t=>{b.value&&ce(t)},Ce=(t,e)=>{b.value&&(ce(e),k.value={groupId:t,index:ie(t).length})},We=(t,e,o)=>{b.value&&(ce(o),k.value={groupId:t,index:e})},R=(t=!1)=>{(t||M.value.sourceGroupId==="unassigned")&&U(),M.value={studentIds:[],sourceGroupId:null},k.value={groupId:null,index:null}},qe=t=>{if(!b.value||!M.value.studentIds.length)return;const e=k.value.groupId===t&&k.value.index!==null?k.value.index:ie(t).length;de(M.value.studentIds,t,e),R()},Ke=(t,e)=>{if(!b.value||!M.value.studentIds.length)return;const o=ie(t),n=new Set(M.value.studentIds),l=o.slice(0,e).filter(_=>n.has(_.id)).length,m=Math.max(e-l,0);de(M.value.studentIds,t,m),R()},Ye=()=>{b.value&&M.value.studentIds.length&&(He(M.value.studentIds),R(!0))},de=(t,e,o)=>{if(!t.length)return;const n=t.map(m=>c.classInfo.students.find(_=>_.id===m)).filter(m=>!!m).map(m=>({...m}));if(!n.length)return;const l=r.value.map(m=>{const _=m.members.filter(B=>!t.includes(B.id));if(m.id!==e)return{...m,members:_};const u=[..._],p=typeof o=="number"?Math.min(Math.max(o,0),u.length):u.length;return u.splice(p,0,...n),{...m,members:u}});r.value=l,x.value||x.value||G()},He=(t,e=!0)=>{t.length&&(r.value=r.value.map(o=>({...o,members:o.members.filter(n=>!t.includes(n.id))})),e&&!x.value&&G())},Je=t=>{if(!b.value){alert("請先進入編輯模式後再使用快速指派");return}if(h.value.length===0){alert("請先在未分組學生列表中選取學生");return}de([...h.value],t),U()},Qe=()=>{if(c.classInfo.groupingActive){alert("分組活動進行中，請先結束後再編輯組別。");return}x.value=!0,O.value=!1,T.setGroupingViewCollapsed(!1),U()},Xe=()=>{G(),x.value=!1,O.value=!0,R(!0)},Ze=()=>{_e(c.classInfo.groups),x.value=!1,O.value=!0,R(!0)},Ge=(t,e)=>{if(!c.classInfo.groupingActive)return;const o=e>0?"animate-score-bounce-green":"animate-score-bounce-red";P.value[t]=o,setTimeout(()=>{P.value[t]===o&&(P.value[t]=null)},500),D.addScoreToGroup(c.classInfo.id,t,e)},et=t=>{const e=r.value.find(n=>n.id===t);if(!e)return;const o=prompt("請輸入新的組名：",e.name);o&&o.trim()&&(e.name=o.trim(),G())},tt=t=>{if(confirm("確定要刪除此組別嗎？組內學生將移至未分組。")){const e=r.value.findIndex(o=>o.id===t);e>-1&&(r.value.splice(e,1),G())}},Ie=(t,e)=>{if(!c.classInfo.groupingActive)return;const o=e>0?"animate-score-bounce-green":"animate-score-bounce-red";J.value[t]=o,setTimeout(()=>{J.value[t]===o&&(J.value[t]=null)},500),D.addIndividualScoreInGroup(c.classInfo.id,t,e)},st=()=>{if(!ge.value){alert("請先將學生分組，才能開始分組活動！");return}const t=r.value.filter(e=>C(e).length===0);if(t.length>0){const e=t.map(n=>n.name||"未命名組").join("、 ");if(!confirm(`以下組別目前沒有成員：${e}。
仍要開始分組活動嗎？`))return}D.startClassGrouping(c.classInfo.id),T.setGroupingViewCollapsed(!0)},nt=()=>{H.value=!0,Y.value?.showModal()},ot=()=>{confirm("確認要重設各組分數嗎？這將清除所有組別的總分。")&&(r.value.forEach(t=>{t.totalScore=0}),G(),D.endClassGrouping(c.classInfo.id),ee(),T.setGroupingViewCollapsed(!1))},lt=()=>{H.value=!1,Y.value?.showModal()},ee=()=>{Y.value?.close(),H.value=!1},De=()=>{const t=new Date,e=t.toISOString().split("T")[0],o=me.value.map((u,p)=>({排行:p+1,組別:u.name,總分:u.totalScore,人數:C(u).length})),n={sheetName:"分組摘要",header:[["活動名稱:",V.value||"未命名"],["班級:",c.classInfo.name],["匯出日期:",t.toLocaleString("zh-TW")],[]],data:o,columnWidths:[{wch:8},{wch:25},{wch:10},{wch:10}]},m={sheetName:"學生得分明細",data:r.value.flatMap(u=>C(u).map(p=>{const B=ae.value[p.id]??0,Ae=fe.value[p.id]??0,at=Ee.value[c.classInfo.id]?.[p.id]??0,it=Pe.value[c.classInfo.id]?.[p.id]??0;return{組別:u.name,座號:p.id,姓名:p.name,出席情況:p.isPresent?"出席":"缺席",小組團體加分:at,小組個人加分:it,本次活動總得分:Ae,活動後總分:B+Ae}})),columnWidths:[{wch:25},{wch:10},{wch:15},{wch:12},{wch:15},{wch:15},{wch:15},{wch:15}]},_=`${e}-${V.value||"分組活動報告"}-${c.classInfo.name}`;z([n,m],_)};return W(()=>c.classInfo.groups,t=>{_e(t),le.value&&(le.value=!1)},{deep:!0,immediate:!0}),W(()=>c.classInfo.groupCount,t=>{const e=oe(t);A.value!==e&&(A.value=e),$.value=String(e)},{immediate:!0}),W(()=>A.value,(t,e)=>{t!==e&&($.value=String(t))}),W(()=>Q.value.map(t=>t.id),t=>{const e=new Set(t);h.value=h.value.filter(o=>e.has(o))}),W(()=>c.classInfo.groupingActive,t=>{t&&(x.value=!1,O.value=!0,U())},{immediate:!0}),(t,e)=>{const o=ct;return i(),a("div",gt,[s("div",ht,[s("div",xt,[t.classInfo.groupingActive?(i(),a("div",jt,[s("div",Nt,[s("span",Vt,[d(o,{name:"CircleDot",class:"w-5 h-5 animate-pulse"}),e[21]||(e[21]=s("span",null,"分組進行中",-1))]),te(s("input",{"onUpdate:modelValue":e[2]||(e[2]=n=>V.value=n),type:"text",placeholder:"請輸入活動名稱...",class:"input input-sm input-bordered w-52"},null,512),[[se,V.value]])]),s("div",Et,[s("button",{onClick:he,class:"btn btn-sm btn-outline gap-1",disabled:r.value.length===0,title:"展開所有組員"},[d(o,{name:"ChevronDown",class:"w-4 h-4"}),e[22]||(e[22]=f(" 展開組員 ",-1))],8,Pt),s("button",{onClick:xe,class:"btn btn-sm btn-outline gap-1",disabled:r.value.length===0,title:"收合所有組員"},[d(o,{name:"ChevronUp",class:"w-4 h-4"}),e[23]||(e[23]=f(" 收合組員 ",-1))],8,Ut),s("button",{onClick:De,class:"btn btn-sm btn-info gap-1",disabled:!V.value.trim(),title:"匯出活動報告"},[d(o,{name:"Download",class:"w-4 h-4"}),e[24]||(e[24]=f(" 匯出 ",-1))],8,Lt),s("button",{onClick:lt,class:"btn btn-sm btn-warning gap-1",title:"顯示積分儀表板"},[d(o,{name:"Trophy",class:"w-4 h-4"}),e[25]||(e[25]=f(" 儀表板 ",-1))]),s("button",{onClick:nt,class:"btn btn-sm btn-error gap-1"},[d(o,{name:"Square",class:"w-4 h-4"}),e[26]||(e[26]=f(" 結束分組 ",-1))])])])):(i(),a("div",_t,[x.value?(i(),a("div",wt,[s("span",yt,[d(o,{name:"Pencil",class:"w-3 h-3"}),e[9]||(e[9]=f("編輯模式中 ",-1))]),s("div",kt,[e[10]||(e[10]=s("label",{class:"label py-1 mr-1"},[s("span",{class:"label-text"},"組數")],-1)),te(s("input",{"onUpdate:modelValue":e[0]||(e[0]=n=>$.value=n),type:"number",min:"2",max:"10",class:"input input-bordered w-20",onBlur:Z,onKeyup:dt(Z,["enter"])},null,544),[[se,$.value]])]),s("button",{onClick:Fe,class:"btn btn-outline"},[d(o,{name:"PlusCircle",class:"w-4 h-4 mr-2"}),e[11]||(e[11]=f("建立組別 ",-1))]),s("button",{onClick:ze,class:"btn btn-primary"},[d(o,{name:"Shuffle",class:"w-4 h-4 mr-2"}),e[12]||(e[12]=f("一鍵隨機分組 ",-1))]),s("button",{onClick:Oe,class:"btn btn-ghost"},[d(o,{name:"Undo2",class:"w-4 h-4 mr-2"}),e[13]||(e[13]=f("一鍵還原 ",-1))]),s("div",St,[s("button",{onClick:Xe,class:"btn btn-success",disabled:r.value.length===0},[d(o,{name:"Save",class:"w-4 h-4 mr-2"}),e[14]||(e[14]=f("儲存組別編輯 ",-1))],8,Ct),s("button",{onClick:Ze,class:"btn btn-ghost"}," 取消 ")])])):(i(),a("div",Gt,[s("div",It,[s("span",Dt,[d(o,{name:"Lock",class:"w-4 h-4"}),e[15]||(e[15]=f("鎖定 ",-1))]),e[16]||(e[16]=s("span",null,"活動名稱 (選填)",-1)),te(s("input",{"onUpdate:modelValue":e[1]||(e[1]=n=>V.value=n),type:"text",placeholder:"例如：第二次分組討論",class:"input input-bordered w-60"},null,512),[[se,V.value]])]),s("div",At,[s("button",{onClick:he,class:"btn btn-sm btn-outline gap-1",disabled:r.value.length===0,title:"展開所有組員"},[d(o,{name:"ChevronDown",class:"w-4 h-4"}),e[17]||(e[17]=f("展開 ",-1))],8,$t),s("button",{onClick:xe,class:"btn btn-sm btn-outline gap-1",disabled:r.value.length===0,title:"收合所有組員"},[d(o,{name:"ChevronUp",class:"w-4 h-4"}),e[18]||(e[18]=f("收合 ",-1))],8,Mt),s("button",{onClick:Qe,class:"btn btn-outline"},[d(o,{name:"SquarePen",class:"w-4 h-4 mr-2"}),e[19]||(e[19]=f("編輯組別 ",-1))]),s("button",{onClick:st,class:"btn btn-success gap-2",disabled:r.value.length===0||!ge.value},[d(o,{name:"Play",class:"w-4 h-4"}),e[20]||(e[20]=f("開始分組活動 ",-1))],8,Tt)])]))]))])]),s("div",zt,[s("aside",{class:I(["transition-all duration-300 flex-shrink-0",y.value?"w-20":"w-80"])},[s("div",Ft,[s("div",Ot,[t.classInfo.groupingActive?(i(),a(N,{key:1},[s("div",ls,[y.value?g("",!0):(i(),a("h3",as,[d(o,{name:"Trophy",class:"w-5 h-5 mr-2"}),e[28]||(e[28]=f(" 即時積分榜 ",-1))])),s("button",{onClick:e[8]||(e[8]=n=>y.value=!y.value),class:"btn btn-ghost btn-sm btn-circle ml-auto",title:y.value?"展開":"收合"},[d(o,{name:y.value?"ChevronsRight":"ChevronsLeft",class:"w-4 h-4"},null,8,["name"])],8,is)]),y.value?g("",!0):(i(),a("div",rs,[d(ut,{name:"leaderboard",tag:"div",class:"space-y-2"},{default:vt(()=>[(i(!0),a(N,null,q(be.value,(n,l)=>(i(),a("div",{key:n.id,class:I(["p-3 rounded-lg flex items-center gap-3 transition-all",l===0?"bg-amber-100 border-2 border-amber-400":"bg-base-200"])},[s("div",{class:I(["text-lg font-bold w-6 text-center",{"text-amber-500":l===0,"text-slate-400":l>2}])},v(l+1),3),s("div",{class:"w-4 h-4 rounded-full shrink-0",style:ne({backgroundColor:n.color})},null,4),s("div",cs,v(n.name),1),L(j).showGroupTotalScores?(i(),a("div",ds,v(n.totalScore),1)):g("",!0)],2))),128))]),_:1})])),y.value?(i(),a("div",us,[d(o,{name:"Trophy",class:"w-8 h-8 text-base-content/30"})])):g("",!0)],64)):(i(),a(N,{key:0},[s("div",Rt,[y.value?g("",!0):(i(),a("h3",Bt,[d(o,{name:"Users",class:"w-5 h-5 mr-2"}),e[27]||(e[27]=f(" 未分組學生 ",-1)),s("span",Wt,v(Ue.value)+" 人",1)])),s("button",{onClick:e[3]||(e[3]=n=>y.value=!y.value),class:"btn btn-ghost btn-sm btn-circle ml-auto",title:y.value?"展開":"收合"},[d(o,{name:y.value?"ChevronsRight":"ChevronsLeft",class:"w-4 h-4"},null,8,["name"])],8,qt)]),y.value?g("",!0):(i(),a("div",{key:0,class:"flex-1 overflow-y-auto space-y-3 p-1",onDrop:Ye,onDragover:e[6]||(e[6]=E(()=>{},["prevent"])),onDragenter:e[7]||(e[7]=E(()=>{},["prevent"]))},[s("div",Kt,[s("label",Yt,[d(o,{name:"Search",class:"w-4 h-4 text-base-content/60"}),te(s("input",{"onUpdate:modelValue":e[4]||(e[4]=n=>F.value=n),type:"text",class:"grow",placeholder:"搜尋姓名或座號"},null,512),[[se,F.value]]),F.value?(i(),a("button",{key:0,type:"button",class:"btn btn-xs btn-ghost",onClick:e[5]||(e[5]=n=>F.value="")}," 清除 ")):g("",!0)]),s("div",Ht,[s("span",null,"已選 "+v(h.value.length)+" 人",1),s("button",{type:"button",class:"btn btn-ghost btn-xs",disabled:h.value.length===0,onClick:U}," 清除選取 ",8,Jt)])]),(i(!0),a(N,null,q(pe.value,n=>(i(),a("div",{key:n.id,class:I(["p-3 bg-base-200 rounded-lg cursor-move hover:bg-base-300 transition-colors","flex justify-between items-center gap-3",h.value.includes(n.id)&&b.value?"ring-2 ring-primary ring-offset-2":"","mt-2"]),draggable:b.value,onDragstart:l=>ke(n.id,"unassigned",l),onDragend:Se},[s("div",Xt,[b.value?(i(),a("input",{key:0,type:"checkbox",class:"checkbox checkbox-sm mt-1",checked:h.value.includes(n.id),onClick:E(l=>Re(n.id),["stop"])},null,8,Zt)):g("",!0),s("div",es,v(n.name),1),s("div",ts," 座號 "+v(n.id),1)]),s("div",ss,v(n.totalScore)+"分 ",1)],42,Qt))),128)),pe.value.length===0?(i(),a("div",ns," 所有學生都已分組 ")):g("",!0)],32)),y.value?(i(),a("div",os,[d(o,{name:"Users",class:"w-8 h-8 text-base-content/30"})])):g("",!0)],64))])])],2),s("main",{ref_key:"groupsContainer",ref:ve,class:"flex-1 content-start overflow-y-auto",onDragover:E(Be,["prevent"])},[s("div",{class:I(["p-1 gap-4",t.classInfo.groupingActive?"grid grid-cols-4 content-start":"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4"])},[(i(!0),a(N,null,q(r.value,n=>(i(),a("div",{key:n.id,class:"card bg-base-100 shadow-sm"},[s("div",vs,[t.classInfo.groupingActive?(i(),a("div",ys,[s("div",ks,[s("h3",Ss,[s("div",{class:"w-3 h-3 rounded-full shrink-0 mt-1",style:ne({backgroundColor:n.color})},null,4),s("span",null,v(n.name),1)]),L(j).showGroupTotalScores?(i(),a("span",{key:0,class:I(["font-bold text-xl text-primary",P.value[n.id]])},v(n.totalScore),3)):g("",!0)]),s("div",Cs,[s("button",{onClick:l=>Ge(n.id,1),disabled:C(n).every(l=>!l.isPresent),class:"btn btn-md flex-1 font-bold text-base px-4 py-1 rounded-full text-white border-none shadow transition-transform hover:scale-105 bg-gradient-to-r from-green-400 to-emerald-500 hover:from-green-500 hover:to-emerald-600 disabled:opacity-50 disabled:hover:scale-100"}," +1 ",8,Gs),s("button",{onClick:l=>Ge(n.id,-1),disabled:C(n).every(l=>!l.isPresent),class:"btn btn-md flex-1 font-bold text-base px-4 py-1 rounded-full text-white border-none shadow transition-transform hover:scale-105 bg-gradient-to-r from-rose-400 to-red-500 hover:from-rose-500 hover:to-red-600 disabled:opacity-50 disabled:hover:scale-100"}," -1 ",8,Is)])])):(i(),a("div",fs,[s("h3",ps,[s("div",{class:"w-4 h-4 rounded-full shrink-0",style:ne({backgroundColor:n.color})},null,4),s("span",ms,v(n.name),1),s("span",bs,v(C(n).length),1)]),s("div",gs,[s("div",hs,[d(o,{name:"MoreVertical",class:"w-4 h-4"})]),s("ul",xs,[s("li",null,[s("a",{onClick:l=>et(n.id)},[d(o,{name:"Edit",class:"w-4 h-4"}),e[29]||(e[29]=f(" 編輯組名 ",-1))],8,_s)]),s("li",null,[s("a",{onClick:l=>tt(n.id),class:"text-error"},[d(o,{name:"Trash2",class:"w-4 h-4"}),e[30]||(e[30]=f(" 刪除組別 ",-1))],8,ws)])])])])),L(K)?(i(),a("p",Ks," 點擊「展開組員」查看 ")):(i(),a("div",{key:2,class:I(["flex-1 min-h-32 rounded-xl border border-dashed border-base-300 bg-base-100/60 p-2 flex flex-col gap-2 relative mt-2",k.value.groupId===n.id&&k.value.index===C(n).length?"ring-2 ring-primary/60 ring-offset-2":""]),onDrop:l=>qe(n.id),onDragover:E(l=>Ce(n.id,l),["prevent"]),onDragenter:E(l=>Ce(n.id,l),["prevent"])},[b.value?(i(),a("div",As,[s("button",{type:"button",class:"btn btn-ghost btn-xs",disabled:h.value.length===0,onClick:l=>Je(n.id)}," 快速指派 ",8,$s)])):g("",!0),s("div",{class:I(["flex-1",x.value?"grid grid-cols-1 md:grid-cols-2 gap-2":"flex flex-col gap-2"])},[(i(!0),a(N,null,q(C(n),(l,m)=>(i(),a("div",{key:l.id,class:I(["rounded transition-all",b.value?"cursor-move border border-base-200 bg-base-100":l.isPresent?"bg-base-200":"bg-gray-200 text-gray-400 opacity-60",k.value.groupId===n.id&&k.value.index===m?"ring-2 ring-primary ring-offset-2":"",!b.value&&l.isPresent?"hover:bg-base-300":""]),draggable:b.value,onDragstart:_=>ke(l.id,n.id,_),onDragend:Se,onDragover:E(_=>We(n.id,m,_),["prevent"]),onDrop:E(_=>Ke(n.id,m),["stop"])},[x.value?(i(),a("div",Ts,[s("div",js," 座號 "+v(l.id),1),s("div",Ns,v(l.name),1)])):(i(),a("div",Vs,[s("div",Es,[s("div",Ps,[f(v(l.name)+" ",1),l.isPresent?g("",!0):(i(),a("span",Us,"今日缺席"))]),s("div",Ls," 座號 "+v(l.id),1)]),s("div",zs,[c.classInfo.groupingActive?(i(),a(N,{key:0},[L(j).showStudentIndividualScores?(i(),a("div",Fs,[s("span",Os,v(ae.value[l.id]??""),1),e[31]||(e[31]=s("span",{class:"opacity-60"},"分",-1)),d(o,{name:"ArrowRight",class:"w-3 h-3 text-success"}),s("span",{class:I(["text-success font-bold",J.value[l.id]])},v((ae.value[l.id]??0)+(fe.value[l.id]??0)),3),e[32]||(e[32]=s("span",{class:"text-success"},"分",-1))])):g("",!0),L(j).allowIndividualScoring?(i(),a("div",Rs,[s("button",{onClick:_=>Ie(l.id,1),class:"btn btn-xs btn-circle btn-outline btn-success",title:"個人加分"}," + ",8,Bs),s("button",{onClick:_=>Ie(l.id,-1),class:"btn btn-xs btn-circle btn-outline btn-error",title:"個人扣分"}," - ",8,Ws)])):g("",!0)],64)):(i(),a(N,{key:1},[f(v(l.totalScore)+"分 ",1)],64))])]))],42,Ms))),128))],2),C(n).length===0?(i(),a("div",qs,v(b.value?"拖曳學生或點快速指派":"目前沒有組員"),1)):g("",!0)],42,Ds))])]))),128))],2)],544)]),s("dialog",{ref_key:"scoreboardModal",ref:Y,class:"modal"},[s("div",Ys,[s("h3",Hs,[d(o,{name:"Trophy",class:"w-5 h-5 mr-2"}),e[33]||(e[33]=f(" 小組積分儀表板 ",-1))]),s("div",Js,[(i(!0),a(N,null,q(be.value,(n,l)=>(i(),a("div",{key:n.id,class:I(["flex items-center gap-4 p-4 rounded-lg",l===0?"bg-warning/20":l===1?"bg-info/20":l===2?"bg-accent/20":"bg-base-200"])},[s("div",Qs,v(l+1),1),s("div",{class:"w-6 h-6 rounded-full",style:ne({backgroundColor:n.color})},null,4),s("div",Xs,[s("div",Zs,v(n.name),1),s("div",en,v(C(n).length),1)]),L(j).showGroupTotalScores?(i(),a("div",tn,[s("div",sn,v(n.totalScore),1)])):g("",!0)],2))),128))]),s("div",nn,[H.value?(i(),a("div",on,[s("div",ln,[s("div",an,[s("button",{onClick:De,class:"btn btn-info",disabled:!V.value.trim()},[d(o,{name:"Download",class:"w-4 h-4 mr-2"}),e[34]||(e[34]=f(" 匯出活動報表 ",-1))],8,rn),s("button",{onClick:ot,class:"btn btn-warning"}," 結束並重設分數 ")]),s("button",{onClick:ee,class:"btn btn-ghost"}," 取消 ")]),e[35]||(e[35]=s("p",{class:"text-xs text-base-content/60 mt-3 w-full"}," 提醒：設置活動名稱方可匯出活動報告，活動結束後就不可再匯出此次分組活動的報告。 ",-1))])):(i(),a("div",cn,[s("button",{onClick:ee,class:"btn"},"關閉")]))])]),s("form",{method:"dialog",class:"modal-backdrop"},[s("button",{onClick:ee},"close")])],512)])}}}),un=Object.assign(pt(dn,[["__scopeId","data-v-933e4ddb"]]),{__name:"GroupingTab"}),vn={key:0,class:"p-4 sm:p-6"},fn={key:1,class:"text-center p-8"},mn=Me({__name:"grouping",setup(ue){const c=Te(),D=mt(),T=S(()=>D.params.id),z=S(()=>c.classes.find(j=>j.id===T.value));return bt(()=>({title:`${z.value?.name||"班級分組"} - 分組模式`})),(j,K)=>z.value?(i(),a("div",vn,[d(un,{"class-info":z.value},null,8,["class-info"])])):(i(),a("div",fn,[...K[0]||(K[0]=[s("p",null,"正在載入班級資料...",-1),s("span",{class:"loading loading-lg loading-spinner text-primary"},null,-1)])]))}});export{mn as default};
