import{f as at,u as rt,y as it,g as dt,r as c,i as m,z as q,A as ut,c as n,o as l,a as t,j as h,b as M,d as x,L as ct,l as A,v as N,B as K,F as g,n as k,t as a,k as G,x as J,p as Q,C as mt}from"#entry";const vt={class:"p-4 sm:p-6"},bt={class:"flex justify-between items-center mb-4"},pt={class:"flex flex-col sm:flex-row justify-between items-center mb-4 gap-2"},ht={class:"w-full sm:w-1/2"},xt={class:"form-control"},gt={class:"label cursor-pointer"},kt={class:"overflow-x-auto glass-card p-4 rounded-xl"},ft={class:"table"},_t={class:"inline-flex items-center gap-1"},wt={key:0,class:"w-3 h-3"},yt={key:0,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",stroke:"currentColor",class:"w-3 h-3"},Ct={key:1,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",stroke:"currentColor",class:"w-3 h-3"},St={class:"inline-flex items-center gap-1"},Mt={key:0,class:"w-3 h-3"},At={key:0,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",stroke:"currentColor",class:"w-3 h-3"},Ft={key:1,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",stroke:"currentColor",class:"w-3 h-3"},Ht={class:"align-top"},Lt={class:"font-semibold text-base-content"},Dt={key:0,class:"text-xs text-base-content/60 mt-1"},jt={class:"align-top whitespace-nowrap"},Bt={class:"align-top max-w-xs"},$t={class:"text-sm text-base-content/70 whitespace-pre-line"},It={class:"align-top"},Vt={key:0,class:"badge badge-ghost"},zt={key:1,class:"badge badge-success"},Nt={class:"align-top"},Tt={key:0,class:"flex items-center gap-2"},Et=["onClick"],Pt={class:"text-xs text-base-content/60"},Ut={key:1,class:"text-xs text-base-content/60"},Ot={class:"text-right"},Rt={class:"flex justify-end space-x-2"},qt={class:"tooltip","data-tip":"編輯"},Kt=["onClick"],Gt=["data-tip"],Jt=["onClick"],Qt={class:"tooltip","data-tip":"刪除"},Wt=["onClick"],Xt={key:0},Yt={colspan:"6",class:"text-center py-8"},Zt={class:"text-base-content/60"},te={key:0,class:"mt-4 flex flex-col sm:flex-row items-center justify-between gap-3"},ee={class:"text-sm text-base-content/70"},se={class:"join"},oe=["disabled"],ne=["onClick"],le=["disabled"],ae={class:"modal-box max-w-3xl bg-base-100"},re={class:"flex items-start justify-between mb-4"},ie={class:"text-lg font-bold"},de={key:0,class:"text-base-content/70 text-sm font-normal"},ue={key:0,class:"overflow-x-auto"},ce={class:"table table-sm table-zebra"},me={class:"align-top"},ve={class:"font-semibold text-base-content group-hover:text-primary"},be={key:0,class:"text-xs text-base-content/50 mt-1 group-hover:text-base-content/70"},pe={class:"text-center font-medium group-hover:text-primary"},he={key:0,class:"group-hover:text-primary"},xe={key:1,class:"text-base-content/30"},ge={class:"bg-base-200"},ke={class:"text-center"},fe={key:1,class:"py-10 text-center text-base-content/60"},_e={class:"font-bold text-xl mb-2 text-primary"},we={class:"grid grid-cols-1 sm:grid-cols-2 gap-1 p-2 border rounded-lg bg-base-200 max-h-40 overflow-y-auto"},ye=["value"],Ce={class:"label-text"},Se={class:"modal-action mt-6"},Me={type:"submit",class:"btn btn-primary"},F=10,He=at({__name:"homework",setup(Ae){rt({title:"全域作業管理"});const v=it(),H=dt(),B=c(!1),_=c(!1),i=c({hiddenFromClassIds:[]}),w=c(!1),y=c(""),C=c("createdAt"),b=c("desc");function T(o){C.value===o?b.value=b.value==="asc"?"desc":"asc":(C.value=o,b.value="asc")}const p=m(()=>{let o=v.homeworkList.filter(e=>e.isArchived===w.value);if(y.value.trim()){const e=y.value.trim().toLowerCase();o=o.filter(r=>r.name.toLowerCase().includes(e)||(r.notes?.toLowerCase().includes(e)??!1))}return o=[...o].sort((e,r)=>{if(C.value==="name"){const s=e.name.localeCompare(r.name);return b.value==="asc"?s:-s}else{const s=new Date(e.createdAt).getTime()-new Date(r.createdAt).getTime();return b.value==="asc"?s:-s}}),o}),d=c(1),L=m(()=>{const o=Math.ceil(p.value.length/F);return o>0?o:1}),W=m(()=>Array.from({length:L.value},(o,e)=>e+1)),X=m(()=>{const o=(d.value-1)*F;return p.value.slice(o,o+F)}),Y=m(()=>p.value.length===0?0:(d.value-1)*F+1),Z=m(()=>{const o=d.value*F;return Math.min(o,p.value.length)});q([y,w],()=>{d.value=1}),q(L,o=>{d.value>o&&(d.value=o)});const S=["pending","submitted","needs_correction","completed"],tt={pending:{text:"未繳交",short:"未交"},submitted:{text:"已繳交",short:"已交"},needs_correction:{text:"待訂正",short:"待訂"},completed:{text:"已完成",short:"完成"}},D=m(()=>{const o={};if(!Array.isArray(v.homeworkList)||!Array.isArray(H.classes))return o;for(const e of v.homeworkList){const r=H.classes.filter(s=>Array.isArray(e.hiddenFromClassIds)?!e.hiddenFromClassIds.includes(s.id):!0);o[e.id]=r.map(s=>{const u={pending:0,submitted:0,needs_correction:0,completed:0},V=s.homeworkSettings?.find(z=>z.homeworkId===e.id);return!V||!V.studentStatus?{classId:s.id,className:s.name,totalStudents:s.students.length,counts:u,hasData:!1}:(s.students.forEach(z=>{const R=V.studentStatus?.[z.id]??"pending",lt=S.includes(R)?R:"pending";u[lt]+=1}),{classId:s.id,className:s.name,totalStudents:s.students.length,counts:u,hasData:!0})})}return o}),$=c(null),f=c(null),E=m(()=>f.value&&v.homeworkList.find(o=>o.id===f.value)||null),I=m(()=>f.value?D.value[f.value]||[]:[]),P=m(()=>{const o={pending:0,submitted:0,needs_correction:0,completed:0};let e=0;return I.value.forEach(r=>{e+=r.totalStudents,r.hasData&&S.forEach(s=>{o[s]+=r.counts[s]})}),{totalStudents:e,counts:o}}),et=async o=>{(D.value[o]||[]).length!==0&&(f.value=o,await mt(),$.value?.showModal())},U=()=>{$.value?.close()},st=()=>{f.value=null},O=(o=null)=>{o?(_.value=!0,i.value={...o,hiddenFromClassIds:[...o.hiddenFromClassIds||[]]}):(_.value=!1,i.value={name:"",notes:"",hiddenFromClassIds:[]}),B.value=!0},j=()=>{B.value=!1},ot=()=>{i.value.name&&(_.value?v.updateHomework(i.value.id,i.value):v.addHomework({name:i.value.name,notes:i.value.notes,hiddenFromClassIds:i.value.hiddenFromClassIds||[]}),j())},nt=o=>{confirm("確定要刪除這個作業範本嗎？此操作無法復原。")&&v.deleteHomework(o)};return ut(()=>{v.fetchAllHomework(),H.loadFromStorage()}),(o,e)=>{const r=ct;return l(),n("div",vt,[t("div",bt,[e[12]||(e[12]=t("h1",{class:"text-3xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent"}," 全域作業管理 ",-1)),t("button",{class:"btn btn-primary",onClick:e[0]||(e[0]=s=>O())},[M(r,{name:"Plus",class:"w-4 h-4"}),e[11]||(e[11]=x(" 新增作業 ",-1))])]),e[33]||(e[33]=t("p",{class:"mb-6 text-base-content/70"}," 這裡是管理所有班級作業範本的地方。您可以在此建立、編輯、封存作業。 ",-1)),t("div",pt,[t("div",ht,[A(t("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=s=>y.value=s),class:"input input-bordered w-full",placeholder:"搜尋作業名稱或備註..."},null,512),[[N,y.value]])]),t("div",xt,[t("label",gt,[e[13]||(e[13]=t("span",{class:"label-text mr-2"},"顯示已封存作業",-1)),A(t("input",{type:"checkbox","onUpdate:modelValue":e[2]||(e[2]=s=>w.value=s),class:"toggle toggle-primary"},null,512),[[K,w.value]])])])]),t("div",kt,[t("table",ft,[t("thead",null,[t("tr",null,[t("th",{class:"cursor-pointer select-none transition text-base-content/80 hover:text-primary relative group",onClick:e[3]||(e[3]=s=>T("name"))},[t("span",_t,[e[16]||(e[16]=x(" 作業名稱 ",-1)),C.value==="name"?(l(),n("span",wt,[b.value==="asc"?(l(),n("svg",yt,[...e[14]||(e[14]=[t("path",{"stroke-linecap":"round","stroke-width":"2",d:"M8 4l4 6H4l4-6z"},null,-1)])])):(l(),n("svg",Ct,[...e[15]||(e[15]=[t("path",{"stroke-linecap":"round","stroke-width":"2",d:"M8 12l-4-6h8l-4 6z"},null,-1)])]))])):h("",!0)])]),t("th",{class:"cursor-pointer select-none transition text-base-content/80 hover:text-primary relative group",onClick:e[4]||(e[4]=s=>T("createdAt"))},[t("span",St,[e[19]||(e[19]=x(" 建立日期 ",-1)),C.value==="createdAt"?(l(),n("span",Mt,[b.value==="asc"?(l(),n("svg",At,[...e[17]||(e[17]=[t("path",{"stroke-linecap":"round","stroke-width":"2",d:"M8 4l4 6H4l4-6z"},null,-1)])])):(l(),n("svg",Ft,[...e[18]||(e[18]=[t("path",{"stroke-linecap":"round","stroke-width":"2",d:"M8 12l-4-6h8l-4 6z"},null,-1)])]))])):h("",!0)])]),e[20]||(e[20]=t("th",null,"備註",-1)),e[21]||(e[21]=t("th",null,"狀態",-1)),e[22]||(e[22]=t("th",null,"班級概況",-1)),e[23]||(e[23]=t("th",{class:"text-right"},"操作",-1))])]),t("tbody",null,[(l(!0),n(g,null,k(X.value,s=>(l(),n("tr",{key:s.id,class:"align-top"},[t("td",Ht,[t("div",Lt,a(s.name),1),(s.hiddenFromClassIds?.length??0)>0?(l(),n("div",Dt," 已對 "+a(s.hiddenFromClassIds?.length)+" 個班級隱藏 ",1)):h("",!0)]),t("td",jt,a(new Date(s.createdAt).toLocaleDateString()),1),t("td",Bt,[t("p",$t,a(s.notes||"—"),1)]),t("td",It,[s.isArchived?(l(),n("span",Vt,"已封存")):(l(),n("span",zt,"啟用中"))]),t("td",Nt,[(D.value[s.id]||[]).length>0?(l(),n("div",Tt,[t("button",{class:"btn btn-xs btn-outline gap-1",onClick:u=>et(s.id)},[M(r,{name:"BarChart3",class:"w-3 h-3"}),e[24]||(e[24]=t("span",null,"概況",-1))],8,Et),t("span",Pt,a(D.value[s.id].length)+" 班 ",1)])):(l(),n("span",Ut,"尚未指派"))]),t("td",Ot,[t("div",Rt,[t("div",qt,[t("button",{class:"btn btn-ghost btn-sm",onClick:u=>O(s)},[M(r,{name:"Edit",class:"w-4 h-4"})],8,Kt)]),t("div",{class:"tooltip","data-tip":s.isArchived?"恢復":"封存"},[t("button",{class:"btn btn-ghost btn-sm",onClick:u=>G(v).toggleArchive(s.id)},[M(r,{name:s.isArchived?"ArchiveRestore":"Archive",class:"w-4 h-4"},null,8,["name"])],8,Jt)],8,Gt),t("div",Qt,[t("button",{class:"btn btn-ghost btn-sm text-error",onClick:u=>nt(s.id)},[M(r,{name:"Trash2",class:"w-4 h-4"})],8,Wt)])])])]))),128)),p.value.length===0?(l(),n("tr",Xt,[t("td",Yt,[t("p",Zt,a(w.value?"沒有已封存的作業":"尚未建立任何作業範本"),1)])])):h("",!0)])])]),p.value.length>0?(l(),n("div",te,[t("span",ee," 顯示第 "+a(Y.value)+" - "+a(Z.value)+" 筆，共 "+a(p.value.length)+" 筆 ",1),t("div",se,[t("button",{class:"btn btn-sm join-item",disabled:d.value===1,onClick:e[5]||(e[5]=s=>d.value=Math.max(1,d.value-1))}," « ",8,oe),(l(!0),n(g,null,k(W.value,s=>(l(),n("button",{key:s,class:J(["btn btn-sm join-item",{"btn-active":d.value===s}]),onClick:u=>d.value=s},a(s),11,ne))),128)),t("button",{class:"btn btn-sm join-item",disabled:d.value===L.value,onClick:e[6]||(e[6]=s=>d.value=Math.min(L.value,d.value+1))}," » ",8,le)])])):h("",!0),t("dialog",{ref_key:"summaryModalRef",ref:$,class:"modal",onClose:st},[t("div",ae,[t("div",re,[t("div",null,[t("h3",ie,[e[25]||(e[25]=x(" 班級概況 ",-1)),E.value?(l(),n("span",de," - "+a(E.value.name),1)):h("",!0)]),e[26]||(e[26]=t("p",{class:"text-xs text-base-content/60 mt-1"}," 顯示目前已指派班級的繳交狀態統計，協助快速掌握進度。 ",-1))]),t("button",{class:"btn btn-sm btn-ghost",onClick:U},"關閉")]),I.value.length>0?(l(),n("div",ue,[t("table",ce,[t("thead",null,[t("tr",null,[e[27]||(e[27]=t("th",null,"班級",-1)),e[28]||(e[28]=t("th",{class:"text-center"},"學生數",-1)),(l(),n(g,null,k(S,s=>t("th",{key:s,class:"text-center"},a(tt[s].text),1)),64))])]),t("tbody",null,[(l(!0),n(g,null,k(I.value,s=>(l(),n("tr",{key:s.classId,class:"transition-colors hover:bg-primary/10 group"},[t("td",me,[t("div",ve,a(s.className),1),s.hasData?h("",!0):(l(),n("div",be," 尚未設定繳交紀錄 "))]),t("td",pe,a(s.totalStudents),1),(l(),n(g,null,k(S,u=>t("td",{key:u,class:"text-center font-medium transition-colors"},[s.hasData?(l(),n("span",he,a(s.counts[u]),1)):(l(),n("span",xe,"—"))])),64))]))),128))]),t("tfoot",null,[t("tr",ge,[e[29]||(e[29]=t("th",null,"總計",-1)),t("th",ke,a(P.value.totalStudents),1),(l(),n(g,null,k(S,s=>t("th",{key:s,class:"text-center"},a(P.value.counts[s]),1)),64))])])])])):(l(),n("div",fe," 目前沒有可顯示的班級紀錄。 ")),t("div",{class:"modal-action"},[t("button",{class:"btn btn-primary",onClick:U},"了解")])])],544),t("div",{class:J(["modal",{"modal-open":B.value}]),onClick:j},[t("div",{class:"modal-box max-w-lg bg-base-100 shadow-xl",onClick:e[10]||(e[10]=Q(()=>{},["stop"]))},[t("h3",_e,a(_.value?"編輯作業":"新增作業"),1),t("form",{onSubmit:Q(ot,["prevent"]),class:"space-y-5"},[t("div",null,[e[30]||(e[30]=t("label",{class:"label mb-1"},[t("span",{class:"label-text text-base font-semibold"},[x("作業名稱 "),t("span",{class:"text-error"},"*")])],-1)),A(t("input",{type:"text","onUpdate:modelValue":e[7]||(e[7]=s=>i.value.name=s),placeholder:"請輸入作業名稱",class:"input input-bordered w-full focus:outline-primary",required:""},null,512),[[N,i.value.name]])]),t("div",null,[e[31]||(e[31]=t("label",{class:"label mb-1"},[t("span",{class:"label-text text-base font-semibold"},[x("備註 "),t("span",{class:"text-xs text-base-content/60"},"(選填)")])],-1)),A(t("textarea",{"onUpdate:modelValue":e[8]||(e[8]=s=>i.value.notes=s),class:"textarea textarea-bordered w-full min-h-[80px] focus:outline-primary",placeholder:"請輸入備註內容"},null,512),[[N,i.value.notes]])]),t("div",null,[e[32]||(e[32]=t("label",{class:"label mb-1"},[t("span",{class:"label-text text-base font-semibold"},[x("對以下班級隱藏 "),t("span",{class:"text-xs text-base-content/60"},"(可多選)")])],-1)),t("div",we,[(l(!0),n(g,null,k(G(H).classes,s=>(l(),n("label",{key:s.id,class:"flex items-center gap-3 px-2 py-1.5 rounded-md hover:bg-base-300 transition-colors cursor-pointer"},[A(t("input",{type:"checkbox",value:s.id,"onUpdate:modelValue":e[9]||(e[9]=u=>i.value.hiddenFromClassIds=u),class:"checkbox checkbox-sm checkbox-primary"},null,8,ye),[[K,i.value.hiddenFromClassIds]]),t("span",Ce,a(s.name),1)]))),128))])]),t("div",Se,[t("button",{type:"button",class:"btn btn-ghost",onClick:j}," 取消 "),t("button",Me,a(_.value?"儲存變更":"確認新增"),1)])],32),t("button",{class:"btn btn-sm btn-circle btn-ghost absolute right-2 top-2",onClick:j}," ✕ ")])],2)])}}});export{He as default};
