import{f as me,g as pe,D as fe,r as k,i as G,K as xe,c as i,l as $,o as r,a as e,F as g,k as I,v as L,b as c,d as v,n as ge,p as D,J as F,t as u,y as P,j as A,q as U}from"#entry";const he={key:0,class:"space-y-6"},_e={class:"card bg-base-100 shadow-sm"},we={class:"card-body p-4"},ye={class:"flex flex-wrap gap-4 items-end justify-between"},ke={class:"flex flex-wrap gap-4 items-end"},Ce={class:"form-control"},Se=["disabled"],Ge={class:"flex items-center gap-2 mt-4 border-t pt-4"},$e=["disabled"],De={key:1,class:"flex flex-wrap gap-x-4 gap-y-2 items-center justify-between"},Ae={class:"flex items-center gap-3 flex-wrap"},Ne={class:"flex items-center gap-2 text-info font-semibold"},Ee={class:"flex flex-nowrap gap-2 ml-2 overflow-x-auto hide-scrollbar"},Me={class:"ml-1 text-primary"},je={class:"flex items-center gap-2"},Te=["disabled"],Fe={class:"flex gap-6 h-[calc(100vh-220px)]"},Pe={class:"card bg-base-100 shadow-sm h-full flex flex-col"},Ue={class:"card-body flex flex-col h-full"},Ve={class:"flex items-center justify-between mb-4"},Ie={key:0,class:"card-title text-base flex items-center whitespace-nowrap"},Le={class:"badge badge-neutral ml-2"},Re=["title"],Be=["onDragstart"],ze={class:"font-medium"},Je={class:"text-sm text-base-content/70"},Oe={class:"text-sm font-semibold text-primary"},qe={key:0,class:"text-center text-base-content/50 py-8"},Ke={class:"flex-1 grid gap-6 grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 content-start overflow-y-auto overflow-x-auto"},We={class:"card-body"},Ye={class:"flex justify-between items-center mb-4"},He={class:"card-title text-base flex items-center"},Qe={class:"badge badge-neutral ml-2"},Xe={class:"dropdown dropdown-end"},Ze={tabindex:"0",role:"button",class:"btn btn-ghost btn-sm btn-circle"},et={tabindex:"0",class:"dropdown-content menu bg-base-100 rounded-box z-[1] w-48 p-2 shadow"},tt=["onClick"],st=["onClick"],nt=["onClick"],ot=["onClick"],lt={class:"stats shadow mb-3"},at={class:"stat py-2 flex flex-col items-center"},it={class:"stat-value text-2xl text-primary mb-1"},rt={class:"flex gap-2 w-full"},dt=["onClick","disabled","title"],ct=["onClick","disabled","title"],ut=["onDrop"],vt=["onDragstart"],bt={class:"font-medium text-sm flex items-center"},mt={key:0,class:"ml-2 px-2 py-0.5 rounded bg-gray-300 text-xs text-gray-600"},pt={class:"text-xs text-base-content/70"},ft={class:"text-xs font-semibold text-primary flex items-center gap-1"},xt={class:"opacity-60"},gt={class:"text-success font-bold"},ht={key:0,class:"text-center text-base-content/50 py-4 text-sm"},_t={class:"modal-box w-11/12 max-w-4xl"},wt={class:"text-lg font-bold mb-4 flex items-center"},yt={class:"space-y-4"},kt={class:"text-2xl font-bold w-8"},Ct={class:"flex-1"},St={class:"font-semibold"},Gt={class:"text-sm text-base-content/70"},$t={class:"text-right"},Dt={class:"text-2xl font-bold text-primary"},At={class:"modal-action"},Nt={key:0,class:"w-full"},Et={class:"flex justify-between items-center flex-wrap gap-y-2 gap-x-4"},Mt={class:"flex gap-2 flex-wrap"},jt=["disabled"],Tt={key:1,class:"w-full flex justify-end"},Ft={key:1,class:"text-center p-8"},Vt=me({__name:"grouping",setup(Pt){const w=pe(),{currentClass:a,groupingBaseScores:Y,groupingSessionScores:H,groupingActivityNames:Q}=fe(w);function X(l,t){let n=null;return function(...s){n&&clearTimeout(n),n=setTimeout(()=>{l.apply(this,s)},t)}}const N=k(),C=k(a.value?.groupCount||4),S=k(null),d=k([]),h=k(!1),E=k(!1),p=G({get:()=>a.value&&Q.value[a.value.id]||"",set:l=>{a.value&&w.setGroupingActivityName(a.value.id,l)}}),R=G(()=>a.value?Y.value[a.value.id]||{}:{}),Z=G(()=>a.value?H.value[a.value.id]||{}:{}),V=G(()=>a.value?a.value.students.filter(l=>l.isPresent&&!d.value.some(t=>t.members.some(n=>n.id===l.id))):[]),ee=G(()=>[...d.value].sort((l,t)=>t.totalScore-l.totalScore)),m=l=>a.value?l.members.map(t=>a.value.students.find(s=>s.id===t.id)||t):[],f=X(()=>{a.value&&w.updateGroups(a.value.id,d.value)},500),te=(l,t=!0)=>{const n={id:`group_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:l.trim(),members:[],totalScore:0,averageScore:0,createdAt:new Date,color:se()};return d.value.push(n),t&&f(),n},se=()=>{const l=["#3b82f6","#ef4444","#10b981","#f59e0b","#8b5cf6","#ec4899","#06b6d4","#84cc16"];return l[d.value.length%l.length]},ne=()=>{if(a.value&&confirm("這將重新分配所有學生，確定要繼續嗎？")){d.value=[];for(let n=1;n<=C.value;n++)te(`第 ${n} 組`,!1);[...a.value.students.filter(n=>n.isPresent)].sort(()=>Math.random()-.5).forEach((n,s)=>{const o=s%C.value;J(n.id,d.value[o].id,!1)}),f()}},oe=()=>{confirm("這會將所有學生移回未分組狀態，但會保留現有組別。確定嗎？")&&(d.value.forEach(l=>{l.members=[]}),f())},B=l=>{S.value=l},z=l=>{S.value&&(l==="unassigned"?O(S.value):J(S.value,l),S.value=null)},J=(l,t,n=!0)=>{if(!a.value)return;const s=a.value.students.find(y=>y.id===l),o=d.value.find(y=>y.id===t);!s||!o||(O(l,!1),o.members.push({...s}),n&&f())},O=(l,t=!0)=>{d.value.forEach(n=>{const s=n.members.findIndex(o=>o.id===l);s>-1&&n.members.splice(s,1)}),t&&f()},M=(l,t)=>{!a.value||!a.value.groupingActive||w.addScoreToGroup(a.value.id,l,t)},le=l=>{const t=d.value.find(s=>s.id===l);if(!t)return;const n=prompt("請輸入新的組名：",t.name);n&&n.trim()&&(t.name=n.trim(),f())},ae=l=>{if(confirm("確定要刪除此組別嗎？組內學生將移至未分組。")){const t=d.value.findIndex(n=>n.id===l);t>-1&&(d.value.splice(t,1),f())}},ie=()=>{a.value&&w.startClassGrouping(a.value.id)},re=()=>{E.value=!0,N.value?.showModal()},q=()=>{a.value&&w.endClassGrouping(a.value.id),j()},de=()=>{confirm("確認要重設各組分數嗎？這將清除所有組別的總分。")&&(d.value.forEach(l=>{l.totalScore=0}),f(),q())},K=()=>{E.value=!1,N.value?.showModal()},j=()=>{N.value?.close(),E.value=!1},W=()=>{if(!a.value)return;const l=new Date,t=`${l.getFullYear()}-${(l.getMonth()+1).toString().padStart(2,"0")}-${l.getDate().toString().padStart(2,"0")}`,n=`${p.value||"分組活動報告"}-${a.value.name}-${t}.csv`,s=["組別名稱","組別得分","組員座號","組員姓名","組員總分"],o=[];o.push([`活動名稱: ${p.value||"未命名"}`]),o.push([`班級: ${a.value.name}`]),o.push([`匯出日期: ${l.toLocaleString("zh-TW")}`]),o.push([]),o.push(s),d.value.forEach(b=>{const x=m(b);x.length>0?x.forEach(ve=>{const T=a.value.students.find(be=>be.id===ve.id);T&&o.push([b.name,b.totalScore,T.id,T.name,T.totalScore])}):o.push([b.name,b.totalScore,"N/A","本組無成員","N/A"])});const y=b=>{const x=String(b);return x.includes(",")||x.includes('"')||x.includes(`
`)?`"${x.replace(/"/g,'""')}"`:x},ce=o.map(b=>b.map(y).join(",")).join(`
`),ue=new Blob(["\uFEFF"+ce],{type:"text/csv;charset=utf-8;"}),_=document.createElement("a");if(_.download!==void 0){const b=URL.createObjectURL(ue);_.setAttribute("href",b),_.setAttribute("download",n),_.style.visibility="hidden",document.body.appendChild(_),_.click(),document.body.removeChild(_)}};return xe(()=>{a.value&&(d.value=JSON.parse(JSON.stringify(a.value.groups||[])),C.value=a.value.groupCount||4)}),(l,t)=>{const n=ge;return $(a)?(r(),i("div",he,[e("div",_e,[e("div",we,[$(a).groupingActive?(r(),i("div",De,[e("div",Ae,[e("span",Ne,[c(n,{name:"CircleDot",class:"w-5 h-5 animate-pulse"}),t[15]||(t[15]=e("span",null,"分組進行中",-1))]),I(e("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>p.value=s),type:"text",placeholder:"請輸入活動名稱...",class:"input input-sm input-bordered w-auto max-w-xs"},null,512),[[L,p.value]]),e("div",Ee,[(r(!0),i(g,null,D(d.value,s=>(r(),i("div",{key:s.id,class:"flex items-center px-2 py-1 rounded bg-base-200 text-xs font-semibold min-w-[70px] border border-base-300",style:F({borderColor:s.color})},[e("span",{class:"w-2 h-2 rounded-full mr-1",style:F({backgroundColor:s.color})},null,4),e("span",null,u(s.name),1),e("span",Me,u(s.totalScore)+" 分",1)],4))),128))])]),e("div",je,[e("button",{onClick:W,class:"btn btn-sm btn-info gap-1",disabled:!p.value.trim(),title:"匯出活動報告"},[c(n,{name:"Download",class:"w-4 h-4"}),t[16]||(t[16]=v(" 匯出 ",-1))],8,Te),e("button",{onClick:K,class:"btn btn-sm btn-warning gap-1",title:"顯示積分儀表板"},[c(n,{name:"Trophy",class:"w-4 h-4"}),t[17]||(t[17]=v(" 儀表板 ",-1))]),e("button",{onClick:re,class:"btn btn-sm btn-error gap-1"},[c(n,{name:"Square",class:"w-4 h-4"}),t[18]||(t[18]=v(" 結束分組 ",-1))])])])):(r(),i(g,{key:0},[e("div",ye,[e("div",ke,[e("div",Ce,[t[9]||(t[9]=e("label",{class:"label py-1 mr-2"},[e("span",{class:"label-text"},"組數")],-1)),I(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>C.value=s),type:"number",min:"2",max:"10",class:"input input-bordered w-20"},null,512),[[L,C.value,void 0,{number:!0}]])]),e("button",{onClick:ne,class:"btn btn-primary"},[c(n,{name:"Shuffle",class:"w-4 h-4 mr-2"}),t[10]||(t[10]=v(" 一鍵隨機分組 ",-1))]),e("button",{onClick:oe,class:"btn btn-ghost"},[c(n,{name:"Undo2",class:"w-4 h-4 mr-2"}),t[11]||(t[11]=v(" 一鍵還原 ",-1))])]),e("button",{onClick:ie,class:"btn btn-success gap-2",disabled:d.value.length===0},[c(n,{name:"Play",class:"w-4 h-4"}),t[12]||(t[12]=v(" 開始分組 ",-1))],8,Se)]),e("div",Ge,[t[14]||(t[14]=e("label",{class:"whitespace-nowrap text-base-content/80 mr-2"},"活動名稱 (選填)",-1)),I(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>p.value=s),type:"text",placeholder:"例如：第二次分組討論",class:"input input-bordered flex-1 min-w-0"},null,512),[[L,p.value]]),e("button",{onClick:K,class:"btn btn-warning ml-2",disabled:d.value.length===0},[c(n,{name:"Trophy",class:"w-4 h-4 mr-2"}),t[13]||(t[13]=v(" 積分儀表板 ",-1))],8,$e)])],64))])]),e("div",Fe,[e("aside",{class:P(["transition-all duration-300 flex-shrink-0",h.value?"w-20":"w-80"])},[e("div",Pe,[e("div",Ue,[e("div",Ve,[h.value?A("",!0):(r(),i("h3",Ie,[c(n,{name:"Users",class:"w-5 h-5 mr-2"}),t[19]||(t[19]=v(" 未分組學生 ",-1)),e("span",Le,u(V.value.length)+" 人",1)])),e("button",{onClick:t[3]||(t[3]=s=>h.value=!h.value),class:"btn btn-ghost btn-sm btn-circle",title:h.value?"展開":"收合"},[c(n,{name:h.value?"ChevronsRight":"ChevronsLeft",class:"w-4 h-4"},null,8,["name"])],8,Re)]),h.value?A("",!0):(r(),i("div",{key:0,class:"flex-1 overflow-y-auto space-y-2 p-1",onDrop:t[4]||(t[4]=s=>z("unassigned")),onDragover:t[5]||(t[5]=U(()=>{},["prevent"])),onDragenter:t[6]||(t[6]=U(()=>{},["prevent"]))},[(r(!0),i(g,null,D(V.value,s=>(r(),i("div",{key:s.id,class:P(["p-3 bg-base-200 rounded-lg cursor-move hover:bg-base-300 transition-colors","flex justify-between items-center"]),draggable:"true",onDragstart:o=>B(s.id)},[e("div",null,[e("div",ze,u(s.name),1),e("div",Je," 座號 "+u(s.id),1)]),e("div",Oe,u(s.totalScore)+"分 ",1)],40,Be))),128)),V.value.length===0?(r(),i("div",qe," 所有學生都已分組 ")):A("",!0)],32))])])],2),e("main",Ke,[(r(!0),i(g,null,D(d.value,s=>(r(),i("div",{key:s.id,class:"card bg-base-100 shadow-sm"},[e("div",We,[e("div",Ye,[e("h3",He,[e("div",{class:"w-4 h-4 rounded-full mr-2",style:F({backgroundColor:s.color})},null,4),v(" "+u(s.name)+" ",1),e("span",Qe,u(m(s).length)+" 人",1)]),e("div",Xe,[e("div",Ze,[c(n,{name:"MoreVertical",class:"w-4 h-4"})]),e("ul",et,[e("li",null,[e("a",{onClick:o=>le(s.id)},[c(n,{name:"Edit",class:"w-4 h-4"}),t[20]||(t[20]=v(" 編輯組名 ",-1))],8,tt)]),e("li",null,[e("a",{onClick:o=>M(s.id,1),class:"text-success"},[c(n,{name:"Plus",class:"w-4 h-4"}),t[21]||(t[21]=v(" 加 1 分 ",-1))],8,st)]),e("li",null,[e("a",{onClick:o=>M(s.id,-1),class:"text-error"},[c(n,{name:"Minus",class:"w-4 h-4"}),t[22]||(t[22]=v(" 扣 1 分 ",-1))],8,nt)]),e("li",null,[e("a",{onClick:o=>ae(s.id),class:"text-error"},[c(n,{name:"Trash2",class:"w-4 h-4"}),t[23]||(t[23]=v(" 刪除組別 ",-1))],8,ot)])])])]),e("div",lt,[e("div",at,[t[24]||(t[24]=e("div",{class:"stat-title text-xs"},"總分",-1)),e("div",it,u(s.totalScore),1),e("div",rt,[e("button",{onClick:o=>M(s.id,1),class:"btn btn-success btn-xs flex-1 text-white text-lg py-3",disabled:!$(a).groupingActive||m(s).every(o=>!o.isPresent),title:m(s).every(o=>!o.isPresent)?"本組全員缺席，無法加分":""}," +1 ",8,dt),e("button",{onClick:o=>M(s.id,-1),class:"btn btn-error btn-xs flex-1 text-white text-lg py-3",disabled:!$(a).groupingActive||m(s).every(o=>!o.isPresent),title:m(s).every(o=>!o.isPresent)?"本組全員缺席，無法扣分":""}," -1 ",8,ct)])])]),e("div",{class:"min-h-32 p-3 border-2 border-dashed border-base-300 rounded-lg space-y-2",onDrop:o=>z(s.id),onDragover:t[7]||(t[7]=U(()=>{},["prevent"])),onDragenter:t[8]||(t[8]=U(()=>{},["prevent"]))},[(r(!0),i(g,null,D(m(s),o=>(r(),i("div",{key:o.id,class:P(["p-2 rounded cursor-move flex justify-between items-center transition-colors",o.isPresent?"bg-base-200 hover:bg-base-300":"bg-gray-200 text-gray-400 opacity-60"]),draggable:"true",onDragstart:y=>B(o.id)},[e("div",null,[e("div",bt,[v(u(o.name)+" ",1),o.isPresent?A("",!0):(r(),i("span",mt,"今日缺席"))]),e("div",pt,u(o.id),1)]),e("div",ft,[$(a).groupingActive?(r(),i(g,{key:0},[e("span",xt,u(R.value[o.id]??""),1),c(n,{name:"ArrowRight",class:"w-3 h-3 text-success"}),e("span",gt,u((R.value[o.id]??0)+(Z.value[o.id]??0)),1),t[25]||(t[25]=e("span",{class:"text-success"},"分",-1))],64)):(r(),i(g,{key:1},[v(u(o.totalScore)+"分 ",1)],64))])],42,vt))),128)),m(s).length===0?(r(),i("div",ht," 拖拽學生到此組 ")):A("",!0)],40,ut)])]))),128))])]),e("dialog",{ref_key:"scoreboardModal",ref:N,class:"modal"},[e("div",_t,[e("h3",wt,[c(n,{name:"Trophy",class:"w-5 h-5 mr-2"}),t[26]||(t[26]=v(" 小組積分儀表板 ",-1))]),e("div",yt,[(r(!0),i(g,null,D(ee.value,(s,o)=>(r(),i("div",{key:s.id,class:P(["flex items-center gap-4 p-4 rounded-lg",o===0?"bg-warning/20":o===1?"bg-info/20":o===2?"bg-accent/20":"bg-base-200"])},[e("div",kt,u(o+1),1),e("div",{class:"w-6 h-6 rounded-full",style:F({backgroundColor:s.color})},null,4),e("div",Ct,[e("div",St,u(s.name),1),e("div",Gt,u(m(s).length)+" 人 ",1)]),e("div",$t,[e("div",Dt,u(s.totalScore),1)])],2))),128))]),e("div",At,[E.value?(r(),i("div",Nt,[e("div",Et,[e("div",Mt,[e("button",{onClick:W,class:"btn btn-info",disabled:!p.value.trim()},[c(n,{name:"Download",class:"w-4 h-4 mr-2"}),t[27]||(t[27]=v(" 匯出活動報表 ",-1))],8,jt),e("button",{onClick:de,class:"btn btn-warning"}," 結束並重設分數 "),e("button",{onClick:q,class:"btn btn-success"}," 結束並保留分數 ")]),e("button",{onClick:j,class:"btn btn-ghost"}," 取消 ")]),t[28]||(t[28]=e("p",{class:"text-xs text-base-content/60 mt-3 w-full"}," 提醒：設置活動名稱方可匯出活動報告，活動結束後就不可再匯出此次分組活動的報告。 ",-1))])):(r(),i("div",Tt,[e("button",{onClick:j,class:"btn"},"關閉")]))])]),e("form",{method:"dialog",class:"modal-backdrop"},[e("button",{onClick:j},"close")])],512)])):(r(),i("div",Ft,[...t[29]||(t[29]=[e("p",null,"正在載入班級資料...",-1),e("span",{class:"loading loading-lg loading-spinner text-primary"},null,-1)])]))}}});export{Vt as default};
